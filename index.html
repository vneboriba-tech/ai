<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <meta name="description" content="–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç / –ë–ª–æ–≥–µ—Ä / –§–æ—Ç–æ–≥—Ä–∞—Ñ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–∏—Ü–∞" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial; min-height:100%; }
    body { display:flex; flex-direction:column; align-items:center; }
    .container { width:100%; max-width:1040px; padding:24px 20px 48px; }

    header { text-align:center; margin-bottom:24px; }
    .title { font-size:clamp(28px,4vw,48px); font-weight:800; letter-spacing:-0.02em; margin:0; }

    .uploader {
      border:2px dashed var(--border); border-radius:24px;
      padding:40px 24px; text-align:center; transition:.2s;
      background:#f9fafb;
    }
    .uploader:hover { border-color:#93c5fd; background:#f0f9ff; }
    .uploader .logo { width:64px; height:64px; object-fit:contain; opacity:.95; display:block; margin:0 auto 12px; }
    .uploader .headline { font-size:18px; font-weight:700; }
    .uploader .sub { font-size:14px; color:var(--muted); margin-top:6px; }
    .picked { font-size:14px; margin-top:10px; color:#111827; display:none; }
    .picked strong { font-weight:800; }
    .icon { width:16px; height:16px; vertical-align:-3px; margin-right:6px; }

    .roles { margin-top:22px; }
    .roles-title { text-align:center; font-weight:800; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
    @media (min-width: 820px) { .roles-grid { grid-template-columns: repeat(3, 1fr); } }
    .role {
      border:1px solid var(--border); border-radius:16px; padding:18px; background:white; cursor:pointer; transition:.15s;
      font-size:16px; font-weight:700;
    }
    .role:hover { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .role.active { border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,.2); }

    .actions { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .btn { appearance:none; border:0; border-radius:14px; padding:12px 18px; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .link { display:inline-block; border:1px solid var(--border); border-radius:14px; padding:10px 16px; text-decoration:none; color:inherit; }

    .loading { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color: var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .result { margin-top:18px; text-align:center; }
    .result img { width:100%; max-width:860px; border-radius:18px; border:1px solid var(--border); }

    footer { margin-top:40px; text-align:center; color:#6b7280; font-size:14px; }
    .err { color:#dc2626; font-size:14px; display:none; white-space:pre-wrap; }
    .tiny { font-size:12px; color:#6b7280; display:none; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="title">–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1>
    </header>

    <div class="uploader" id="dropzone">
      <img class="logo" src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
      <div class="headline">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
      <div class="sub">JPG, PNG, WEBP (–¥–æ 12 –ú–ë)</div>
      <div class="picked" id="pickedName"></div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <section class="roles">
      <div class="roles-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è üëâ</div>
      <div class="roles-grid">
        <button class="role" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</button>
        <button class="role" data-role="–±–ª–æ–≥–µ—Ä">–ë–ª–æ–≥–µ—Ä</button>
        <button class="role" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ">–§–æ—Ç–æ–≥—Ä–∞—Ñ</button>
      </div>
    </section>

    <div class="actions">
      <button id="genBtn" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
      <div id="loading" class="loading" style="display:none">
        <span class="spinner" aria-hidden="true"></span>
        <span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</span>
      </div>
      <a id="downloadLink" class="link" download="image.png" style="display:none">–°–∫–∞—á–∞—Ç—å PNG</a>
      <div id="err" class="err"></div>
      <div id="debug" class="tiny"></div>
    </div>

    <div class="result" id="resultBox" style="display:none">
      <div style="font-size:13px;color:#6b7280;margin-bottom:6px">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
    </div>
  </div>

  <footer>¬© 2025 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</footer>

  <!-- —Å–∫—Ä—ã—Ç–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ -->
  <img id="logoPreload" src="logo.png?v=1" alt="" style="display:none" crossorigin="anonymous" />

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev"; // ‚Üê —É–∫–∞–∂–∏ —Ç–æ—á–Ω—ã–π URL –≤–æ—Ä–∫–µ—Ä–∞ (–±–µ–∑ —Ö–≤–æ—Å—Ç–æ–≤–æ–≥–æ /)
const LOGO_URL = "logo.png?v=1";
const MAX_FILE_MB = 12;

/* ===== STATE / DOM ===== */
let pickedFile = null;
let pickedRole = null;

const fileInput  = document.getElementById("fileInput");
const dropzone   = document.getElementById("dropzone");
const pickedName = document.getElementById("pickedName");
const genBtn     = document.getElementById("genBtn");
const errBox     = document.getElementById("err");
const resultBox  = document.getElementById("resultBox");
const resultImg  = document.getElementById("resultImg");
const download   = document.getElementById("downloadLink");
const loading    = document.getElementById("loading");
const debugBox   = document.getElementById("debug");

/* ===== Uploader ===== */
dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", e => e.preventDefault());
dropzone.addEventListener("drop", (e) => { e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) onPick(f); });
fileInput.addEventListener("change", (e) => { const f=e.target.files?.[0]; if(f) onPick(f); });

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function humanSize(bytes){return (bytes/1048576).toFixed(1)+' –ú–ë';}
function showError(msg){ errBox.style.display="block"; errBox.textContent=msg; loading.style.display="none"; }
function clearError(){ errBox.style.display="none"; errBox.textContent=""; }
function clearResult(){ resultImg.removeAttribute("src"); resultBox.style.display="none"; download.style.display="none"; download.removeAttribute("href"); }
function updateButtons(){ genBtn.disabled = !(pickedFile && pickedRole); }
function logDebug(s){ debugBox.style.display='block'; debugBox.textContent=s; console.log('[debug]', s); }

function onPick(f){
  if (!(f.type||"").startsWith("image/")) return showError("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
  if (f.size > MAX_FILE_MB*1048576) return showError(`–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (${humanSize(f.size)}).`);
  pickedFile=f;
  pickedName.style.display="block";
  pickedName.classList.add("picked");
  pickedName.innerHTML=`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><strong>–í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏:</strong> ${escapeHtml(f.name)} (${humanSize(f.size)})`;
  clearError(); updateButtons(); clearResult();
}

document.querySelectorAll(".role").forEach(btn => btn.addEventListener("click", ()=>{
  if(!pickedFile) return;
  pickedRole = btn.dataset.role;
  document.querySelectorAll(".role").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  updateButtons();
}));

/* ===== Helpers ===== */
function safeJson(txt){ try { return JSON.parse(txt); } catch { return null; } }
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const i=new Image(); i.crossOrigin="anonymous";
    i.onload=()=>resolve(i); i.onerror=()=>reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: "+src));
    i.src=src + (src.includes("?") ? "" : "?v=" + Date.now());
  });
}
const fileToB64=(f)=>new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]||''); r.onerror=()=>rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª")); r.readAsDataURL(f);});

/* ===== –ú–∞—Å–∫–∞: –ß–Å–†–ù–û–ï ‚Äî –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–ª–∏—Ü–æ/–≥–æ–ª–æ–≤–∞), –ë–ï–õ–û–ï ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (—Ñ–æ–Ω/–æ–¥–µ–∂–¥—É) ===== */
function expandBox(box, scale){
  const cx = box.x + box.w/2, cy = box.y + box.h/2;
  let nw = Math.min(1, box.w * scale), nh = Math.min(1, box.h * scale * 1.35);
  let nx = cx - nw/2, ny = cy - nh/2;
  if (nx < 0) nx = 0; if (ny < 0) ny = 0;
  if (nx + nw > 1) nx = 1 - nw; if (ny + nh > 1) ny = 1 - nh;
  return { x: nx, y: ny, w: nw, h: nh };
}
async function buildHeadMaskB64(srcB64, bbox){
  const img = await loadImage("data:image/png;base64,"+srcB64);
  const W=img.width, H=img.height;
  const c=document.createElement("canvas"); c.width=W; c.height=H;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,W,H);
  if (bbox) {
    const big=expandBox(bbox,1.95);
    const x=Math.round(big.x*W), y=Math.round(big.y*H);
    const w=Math.round(big.w*W), h=Math.round(big.h*H);
    const cx=x+w/2, cy=y+h*0.52; // —á—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞ ‚Äî –∑–∞—Ö–≤–∞—Ç —à–µ–∏
    ctx.save();
    ctx.beginPath(); ctx.ellipse(cx, cy, w*0.45, h*0.62, 0, 0, 2*Math.PI); ctx.clip();
    ctx.fillStyle="#000000"; ctx.fillRect(x,y,w,h);
    ctx.restore();
  }
  return c.toDataURL("image/png").split(",")[1] || "";
}

/* ===== –õ–æ–≥–æ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É ===== */
async function addLogoToBase64(b64){
  try{
    const base = await loadImage("data:image/png;base64," + b64);
    let logoEl = document.getElementById('logoPreload');
    let logo = (logoEl && logoEl.naturalWidth) ? logoEl : await loadImage(LOGO_URL);

    const W=base.width, H=base.height;
    const c=document.createElement("canvas"); c.width=W; c.height=H;
    const ctx=c.getContext("2d"); ctx.drawImage(base,0,0,W,H);

    const margin = Math.round(Math.min(W,H)*0.02);
    const targetW = Math.round(W * 0.16);
    const ratio = (logo.naturalWidth||logo.width)/(logo.naturalHeight||logo.height);
    const targetH = Math.round(targetW/ratio);
    const x = W - targetW - margin;
    const y = H - targetH - margin;

    // –±–µ–ª–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏—è–º–∏
    const pad = Math.round(targetW * 0.10);
    const bx = x - pad, by = y - pad, bw = targetW + pad*2, bh = targetH + pad*2;
    const r = Math.round(Math.min(bw, bh) * 0.18);
    ctx.save();
    roundRect(ctx, bx, by, bw, bh, r);
    ctx.fillStyle = "rgba(255,255,255,0.94)";
    ctx.fill();
    ctx.restore();

    ctx.globalAlpha = 0.98;
    ctx.drawImage(logo, x, y, targetW, targetH);
    ctx.globalAlpha = 1;

    return c.toDataURL('image/png');
  }catch(e){
    console.warn("Logo overlay failed:", e.message);
    return "data:image/png;base64," + b64;
  }
}
function roundRect(ctx, x, y, w, h, r){
  r = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

/* ===== Main ===== */
genBtn.addEventListener("click", async () => {
  clearError(); clearResult();
  try{
    if (!/^https?:\/\//i.test(API_BASE)) throw new Error("API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ.");
    if (!pickedFile || !pickedRole) throw new Error("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.");

    loading.style.display = "flex";
    genBtn.disabled = true;

    // —á–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫ –≤ b64 (–¥–ª—è /detect-face –∏ mask_b64)
    const srcB64 = await fileToB64(pickedFile);

    // 1) –¥–µ—Ç–µ–∫—Ç –≥–æ–ª–æ–≤—ã (–±—ç–∫–µ–Ω–¥ ‚Äî –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–µ–Ω)
    let bbox=null, maskB64="";
    try {
      const fdD=new FormData(); fdD.append("image_b64", srcB64);
      const r=await fetch(API_BASE.replace(/\/+$/,'') + "/api/detect-face", { method:"POST", body:fdD });
      const j= safeJson(await r.text());
      bbox = j?.face?.box || null;
      if (!bbox) throw 0;
      maskB64 = await buildHeadMaskB64(srcB64, bbox);
    } catch(e){ throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ª–∏—Ü–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–æ—Ç–æ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ/—á—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ."); }

    // 2) –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –∫–∞–∫ –µ—Å—Ç—å + –º–∞—Å–∫—É)
    const fd = new FormData();
    fd.append("role", pickedRole);
    fd.append("image_b64", srcB64); // base64 —Å—Ç–∞–±–∏–ª–µ–Ω –¥–ª—è CF AI
    fd.append("mask_b64", maskB64);

    const resp = await fetch(API_BASE.replace(/\/+$/,'') + "/api/generate", { method:"POST", body: fd });
    const raw  = await resp.text();

    if (!resp.ok) {
      let msg = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
      try { const j = JSON.parse(raw); msg = j.error || msg; } catch {}
      throw new Error(msg);
    }
    const data = safeJson(raw);
    if (!data?.imageBase64) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç API");

    // 3) –ª–æ–≥–æ
    const finalUrl = await addLogoToBase64(data.imageBase64);
    resultImg.src = finalUrl;
    resultBox.style.display = "block";
    download.href = finalUrl;
    download.style.display = "inline-block";
  } catch (e) {
    showError(e.message || String(e));
  } finally {
    loading.style.display = "none";
    genBtn.disabled = !(pickedFile && pickedRole);
  }
});
</script>
</body>
</html>

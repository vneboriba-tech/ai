<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Обнови фото с сохранением лица</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .uploader { border: 2px dashed #888; padding: 40px; text-align: center; background: white; }
    .logo { width: 80px; margin-bottom: 20px; }
    .picked { margin-top: 10px; color: #333; }
    .roles button { margin: 5px; padding: 10px 20px; font-weight: bold; }
    .btn { padding: 12px 24px; font-weight: bold; background: #2563eb; color: white; border: none; cursor: pointer; }
    .btn:disabled { background: #aaa; cursor: not-allowed; }
    .loading { display:none; margin-top: 10px; }
    .err { color: red; margin-top: 10px; }
    .result { margin-top:20px; }
    .result img { max-width: 100%; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="uploader">
    <img class="logo" src="logo.png" alt="Логотип" onerror="this.style.display='none'">
    <div>Загрузите своё фото</div>
    <input type="file" id="fileInput" accept="image/*">
    <div class="picked" id="pickedName"></div>
  </div>

  <div class="roles">
    <button data-role="журналист">Журналист</button>
    <button data-role="блогер">Блогер</button>
    <button data-role="фотограф">Фотограф</button>
  </div>

  <div class="actions">
    <button id="genBtn" class="btn" disabled>Обновить образ</button>
    <div id="loading" class="loading">Обрабатываем...</div>
    <div id="err" class="err"></div>
  </div>

  <div class="result" id="resultBox">
    <img id="resultImg" alt="Результат" />
    <div><a id="downloadLink" download="result.png">Скачать результат</a></div>
  </div>

<script>
  const fileInput = document.getElementById("fileInput");
  const pickedName = document.getElementById("pickedName");
  const roleButtons = document.querySelectorAll(".roles button");
  const genBtn = document.getElementById("genBtn");
  const loading = document.getElementById("loading");
  const errDiv = document.getElementById("err");
  const resultBox = document.getElementById("resultBox");
  const resultImg = document.getElementById("resultImg");
  const downloadLink = document.getElementById("downloadLink");

  let selectedFile = null;
  let selectedRole = null;

  fileInput.addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) return;
    if (!f.type.startsWith("image/")) {
      errDiv.textContent = "Пожалуйста, загрузите изображение.";
      return;
    }
    selectedFile = f;
    pickedName.textContent = `Выбран: ${f.name}`;
    updateBtn();
  });

  roleButtons.forEach(b => {
    b.addEventListener("click", () => {
      roleButtons.forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      selectedRole = b.dataset.role;
      updateBtn();
    });
  });

  function updateBtn() {
    genBtn.disabled = !(selectedFile && selectedRole);
  }

  async function fileToBase64(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => {
        const s = reader.result;
        const parts = s.split(",");
        res(parts.length > 1 ? parts[1] : parts[0]);
      };
      reader.onerror = () => rej();
      reader.readAsDataURL(file);
    });
  }

  genBtn.addEventListener("click", async () => {
    errDiv.textContent = "";
    loading.style.display = "block";
    genBtn.disabled = true;
    resultBox.style.display = "none";

    try {
      const b64 = await fileToBase64(selectedFile);
      const body = new FormData();
      body.append("role", selectedRole);
      body.append("image_b64", b64);

      const resp = await fetch("/api/generate", {
        method: "POST",
        body: body
      });
      const txt = await resp.text();
      if (!resp.ok) {
        let msg = `Ошибка генерации: ${resp.status}`;
        try {
          const j = JSON.parse(txt);
          msg = j.error || msg;
        } catch {}
        throw new Error(msg);
      }
      const j = JSON.parse(txt);
      if (!j.imageBase64) throw new Error("В ответе нет изображения");

      const dataUrl = "data:image/png;base64," + j.imageBase64;
      resultImg.src = dataUrl;
      downloadLink.href = dataUrl;
      resultBox.style.display = "block";

    } catch (e) {
      errDiv.textContent = e.message;
    } finally {
      loading.style.display = "none";
      genBtn.disabled = false;
    }
  });
</script>

</body>
</html>

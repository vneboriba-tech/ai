<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <meta name="description" content="–ú–∏–Ω–∏-—Å–∞–π—Ç: –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç / –ë–ª–æ–≥–µ—Ä / –§–æ—Ç–æ–≥—Ä–∞—Ñ" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; min-height:100%; }
    body { display:flex; flex-direction:column; }
    .container { max-width: 1040px; margin: 0 auto; padding: 24px 20px 48px; width:100%; }
    header { display:flex; align-items:center; justify-content:center; position:relative; padding: 8px 0 24px; }
    .title { font-size: clamp(28px, 4vw, 48px); font-weight:800; letter-spacing:-0.02em; margin:0; text-align:center; }

    .uploader { border:2px dashed var(--border); background:#f9fafb; border-radius:24px; padding:40px 24px; text-align:center; transition:.2s ease; }
    .uploader:hover { border-color:#93c5fd; background:#f0f9ff; }
    .uploader .logo { width:64px; height:64px; object-fit:contain; opacity:.9; margin:0 auto 12px; display:block; }
    .uploader .headline { font-size: clamp(18px, 2.4vw, 22px); font-weight:600; }
    .uploader .sub { font-size:14px; color: var(--muted); margin-top:6px; }
    .uploader .picked { margin-top:10px; font-size:14px; color:#111827; display:none; }
    .uploader .picked strong { font-weight:800; }
    .icon { width:16px; height:16px; vertical-align:-3px; margin-right:6px; }

    .roles { margin-top:22px; }
    .roles-title { text-align:center; font-weight:800; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns: 1fr; gap:12px; margin-top:10px; }
    @media (min-width: 820px) { .roles-grid { grid-template-columns: repeat(3, 1fr); } }
    .role { border:1px solid var(--border); border-radius:16px; padding:18px; background:white; cursor:pointer; transition:.15s; }
    .role:hover { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .role.active { border-color:#3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,.2); }

    .actions { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .btn { appearance:none; border:0; border-radius:14px; padding:12px 18px; background:var(--brand); color:#fff; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .link { display:inline-block; border:1px solid var(--border); border-radius:14px; padding:10px 16px; text-decoration:none; color:inherit; }

    .loading { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color: var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .result { margin-top:18px; text-align:center; }
    .result img { width:100%; max-width:860px; border-radius:18px; border:1px solid var(--border); }

    footer { margin-top:auto; text-align:center; color:#111827; font-size:14px; padding:24px 0; border-top:1px solid #e5e7eb; background:#ffffff; }
    footer .sub { font-size:13px; color:#6b7280; }

    .tiny { font-size:12px; color:#6b7280; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1 class="title">–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1></header>

    <div class="uploader" id="dropzone">
      <img class="logo" src="./logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
      <div class="headline">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
      <div class="sub">JPG, PNG, WEBP</div>
      <div class="picked" id="pickedName"></div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <section class="roles">
      <div class="roles-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è üëâ</div>
      <div class="roles-grid">
        <button class="role" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç"><div style="font-size:16px;font-weight:600">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</div></button>
        <button class="role" data-role="–±–ª–æ–≥–µ—Ä"><div style="font-size:16px;font-weight:600">–ë–ª–æ–≥–µ—Ä</div></button>
        <button class="role" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ"><div style="font-size:16px;font-weight:600">–§–æ—Ç–æ–≥—Ä–∞—Ñ</div></button>
      </div>
    </section>

    <div class="actions">
      <button id="genBtn" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
      <div id="loading" class="loading" style="display:none">
        <span class="spinner" aria-hidden="true"></span>
        <span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</span>
      </div>
      <a id="downloadLink" class="link" download="image.png" style="display:none">–°–∫–∞—á–∞—Ç—å PNG</a>
      <div id="err" style="font-size:14px;color:#dc2626;display:none"></div>
      <div class="tiny" id="debug" style="display:none"></div>
    </div>

    <div class="result" id="resultBox" style="display:none">
      <div style="font-size:13px;color:#6b7280;margin-bottom:6px">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
    </div>
  </div>

  <footer>
    <div>—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</div>
    <div class="sub">¬© 2025 —Å –ª—é–±–æ–≤—å—é –ö–ú‚Ñ¢</div>
  </footer>

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
const MAX_FILE_MB = 12;

let pickedFile = null;
let pickedRole = null;

const fileInput = document.getElementById("fileInput");
const dropzone = document.getElementById("dropzone");
const genBtn = document.getElementById("genBtn");
const errBox = document.getElementById("err");
const resultBox = document.getElementById("resultBox");
const resultImg = document.getElementById("resultImg");
const downloadLink = document.getElementById("downloadLink");
const loading = document.getElementById("loading");
const debugBox = document.getElementById("debug");
const pickedName = document.getElementById("pickedName");

dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", e => e.preventDefault());
dropzone.addEventListener("drop", e => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f) onPick(f); });
fileInput.addEventListener("change", e => { const f = e.target.files?.[0]; if (f) onPick(f); });

function onPick(f){
  if (!(f.type||"").startsWith("image/")) return showError("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
  if (f.size > MAX_FILE_MB*1048576) return showError(`–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (${(f.size/1048576).toFixed(1)} –ú–ë).`);
  pickedFile = f;
  pickedName.style.display = "block";
  pickedName.innerHTML = `‚úÖ <strong>–í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏:</strong> ${f.name}`;
  clearError();
  genBtn.disabled = !(pickedFile && pickedRole);
  clearResult();
}

document.querySelectorAll(".role").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!pickedFile) return;
    pickedRole = btn.dataset.role;
    document.querySelectorAll(".role").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    genBtn.disabled = !(pickedFile && pickedRole);
  });
});

function showError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
  loading.style.display = "none";
}
function clearError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}
function clearResult(){
  resultImg.removeAttribute("src");
  resultBox.style.display = "none";
  downloadLink.style.display = "none";
  downloadLink.removeAttribute("href");
}

function safeJson(txt){
  try { return JSON.parse(txt); } catch { return null; }
}

async function fileToB64(f){
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(String(r.result).split(',')[1] || '');
    r.onerror = () => rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª"));
    r.readAsDataURL(f);
  });
}

function logDebug(msg){
  debugBox.style.display = "block";
  debugBox.textContent += msg + "\n";
  console.log("[debug]", msg);
}

function expandBox(box, scale){
  const cx = box.x + box.w/2, cy = box.y + box.h/2;
  let nw = Math.min(1, box.w * scale), nh = Math.min(1, box.h * scale * 1.2);
  let nx = cx - nw/2, ny = cy - nh/2;
  if (nx < 0) nx = 0;
  if (ny < 0) ny = 0;
  if (nx + nw > 1) nx = 1 - nw;
  if (ny + nh > 1) ny = 1 - nh;
  return { x: nx, y: ny, w: nw, h: nh };
}

async function buildHeadMaskB64(srcB64, bbox){
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.crossOrigin = "anonymous";
    i.onload = () => res(i);
    i.onerror = () => rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å load src image"));
    i.src = "data:image/png;base64," + srcB64;
  });
  const W = img.width, H = img.height;
  const c = document.createElement("canvas");
  c.width = W; c.height = H;
  const ctx = c.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, W, H);
  if (bbox) {
    const big = expandBox(bbox, 2.0);
    const x = Math.round(big.x * W), y = Math.round(big.y * H);
    const w = Math.round(big.w * W), h = Math.round(big.h * H);
    ctx.save();
    ctx.beginPath();
    ctx.ellipse(x + w/2, y + h/2, w * 0.5, h * 0.66, 0, 0, Math.PI*2);
    ctx.clip();
    ctx.fillStyle = "#000000";
    ctx.fillRect(x, y, w, h);
    ctx.restore();
  }
  return c.toDataURL("image/png").split(",")[1] || "";
}

async function composeFaceAndLogo(genB64, srcB64, bbox){
  const [genImg, srcImg] = await Promise.all([
    new Promise((res, rej) => {
      const i = new Image();
      i.crossOrigin = "anonymous";
      i.onload = () => res(i);
      i.onerror = () => rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å load gen image"));
      i.src = "data:image/png;base64," + genB64;
    }),
    new Promise((res, rej) => {
      const i = new Image();
      i.crossOrigin = "anonymous";
      i.onload = () => res(i);
      i.onerror = () => rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å load src image"));
      i.src = "data:image/png;base64," + srcB64;
    })
  ]);
  
  const W = genImg.width, H = genImg.height;
  const canvas = document.createElement("canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(genImg, 0, 0, W, H);

  if (bbox) {
    const big = expandBox(bbox, 1.8);
    const sx = Math.round(big.x * srcImg.width), sy = Math.round(big.y * srcImg.height);
    const sw = Math.round(big.w * srcImg.width), sh = Math.round(big.h * srcImg.height);
    const dx = Math.round(big.x * W), dy = Math.round(big.y * H);
    const dw = Math.round(big.w * W), dh = Math.round(big.h * H);

    const mask = document.createElement("canvas");
    mask.width = dw; mask.height = dh;
    const mctx = mask.getContext("2d");
    const r = Math.min(dw, dh);
    const grad = mctx.createRadialGradient(dw/2, dh/2, r*0.3, dw/2, dh/2, r*0.5);
    grad.addColorStop(0, "rgba(0,0,0,1)");
    grad.addColorStop(1, "rgba(0,0,0,0)");
    mctx.fillStyle = grad;
    mctx.fillRect(0, 0, dw, dh);

    const face = document.createElement("canvas");
    face.width = dw; face.height = dh;
    const fctx = face.getContext("2d");
    fctx.drawImage(srcImg, sx, sy, sw, sh, 0, 0, dw, dh);

    ctx.save();
    ctx.drawImage(face, dx, dy, dw, dh);
    ctx.globalCompositeOperation = 'destination-in';
    ctx.drawImage(mask, dx, dy);
    ctx.restore();
  }

  // –ª–æ–≥–æ—Ç–∏–ø
  try {
    const logo = new Image();
    logo.crossOrigin = "anonymous";
    await new Promise((res, rej) => {
      logo.onload = res; logo.onerror = rej;
      logo.src = "./logo.png";
    });
    const margin = Math.round(Math.min(W, H) * 0.02);
    const targetW = Math.round(W * 0.14);
    const ratio = logo.width / logo.height;
    const targetH = Math.round(targetW / ratio);
    const x = W - targetW - margin;
    const y = H - targetH - margin;
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    const pad = Math.round(targetW * 0.08);
    ctx.fillRect(x - pad, y - pad, targetW + pad*2, targetH + pad*2);
    ctx.drawImage(logo, x, y, targetW, targetH);
    ctx.globalAlpha = 1;
  } catch (e) {
    // –Ω–∏—á–µ–≥–æ
  }

  return canvas.toDataURL("image/png");
}

async function postGen(url, fd, note){
  const r = await fetch(url, { method: "POST", body: fd });
  const text = await r.text();
  logDebug(`${note} ‚Üí ${r.status}\n${text.substring(0, 300)}`);
  return { ok: r.ok, text, json: safeJson(text) };
}

genBtn.addEventListener("click", async () => {
  clearError(); clearResult();
  debugBox.textContent = ""; debugBox.style.display = "block";

  try {
    if (!/^https?:\/\//i.test(API_BASE)) throw new Error("API_BASE –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
    if (!pickedFile || !pickedRole) throw new Error("–§–æ—Ç–æ –∏ —Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");

    loading.style.display = "flex";
    genBtn.disabled = true;

    const srcB64 = await fileToB64(pickedFile);

    // detect-face
    let bbox = null;
    try {
      const fdD = new FormData();
      fdD.append("image_b64", srcB64);
      const resp = await fetch(API_BASE + "/api/detect-face", { method: "POST", body: fdD });
      const txt = await resp.text();
      const j = safeJson(txt);
      logDebug(`detect-face ‚Üí ${resp.status}\n${txt.substring(0,200)}`);
      bbox = j?.face?.box || null;
    } catch (e) {
      logDebug("–û—à–∏–±–∫–∞ detect-face: " + e.message);
    }

    const maskB64 = bbox ? await buildHeadMaskB64(srcB64, bbox) : "";

    const url = API_BASE + "/api/generate";

    // –ø–æ–ø—ã—Ç–∫–∞ 1 ‚Äî file + mask
    {
      const fd1 = new FormData();
      fd1.append("role", pickedRole);
      fd1.append("image", pickedFile);
      if (maskB64) fd1.append("mask_b64", maskB64);
      const r1 = await postGen(url, fd1, "gen[file+mask]");
      if (r1.ok && r1.json?.imageBase64) {
        const finalUrl = bbox
          ? await composeFaceAndLogo(r1.json.imageBase64, srcB64, bbox)
          : await composeFaceAndLogo(r1.json.imageBase64, srcB64, null);
        resultImg.src = finalUrl;
        resultBox.style.display = "block";
        downloadLink.href = finalUrl;
        downloadLink.style.display = "block";
        return;
      }
    }

    // –ø–æ–ø—ã—Ç–∫–∞ 2 ‚Äî b64 + mask
    {
      const fd2 = new FormData();
      fd2.append("role", pickedRole);
      fd2.append("image_b64", srcB64);
      if (maskB64) fd2.append("mask_b64", maskB64);
      const r2 = await postGen(url, fd2, "gen[b64+mask]");
      if (r2.ok && r2.json?.imageBase64) {
        const finalUrl = bbox
          ? await composeFaceAndLogo(r2.json.imageBase64, srcB64, bbox)
          : await composeFaceAndLogo(r2.json.imageBase64, srcB64, null);
        resultImg.src = finalUrl;
        resultBox.style.display = "block";
        downloadLink.href = finalUrl;
        downloadLink.style.display = "block";
        return;
      }
    }

    // –ø–æ–ø—ã—Ç–∫–∞ 3 ‚Äî b64 –±–µ–∑ –º–∞—Å–∫–∏
    {
      const fd3 = new FormData();
      fd3.append("role", pickedRole);
      fd3.append("image_b64", srcB64);
      const r3 = await postGen(url, fd3, "gen[b64 no mask]");
      if (r3.ok && r3.json?.imageBase64) {
        const finalUrl = bbox
          ? await composeFaceAndLogo(r3.json.imageBase64, srcB64, bbox)
          : await composeFaceAndLogo(r3.json.imageBase64, srcB64, null);
        resultImg.src = finalUrl;
        resultBox.style.display = "block";
        downloadLink.href = finalUrl;
        downloadLink.style.display = "block";
        return;
      }
      // –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å
      const errMsg = r3.json?.error || r3.text || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏)";
      throw new Error(errMsg);
    }
  } catch (e) {
    showError("–û—à–∏–±–∫–∞: " + (e.message || String(e)));
  } finally {
    loading.style.display = "none";
    genBtn.disabled = !(pickedFile && pickedRole);
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Почувствуй себя журналистом</title>
  <meta name="description" content="Журналист / Блогер / Фотограф — генерация образа с сохранением лица" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial; min-height:100%; }
    body { display:flex; flex-direction:column; align-items:center; }
    .container { width:100%; max-width:1040px; padding:24px 20px 48px; }

    header { text-align:center; margin-bottom:20px; }
    .title { font-size:clamp(28px,4vw,48px); font-weight:800; letter-spacing:-0.02em; margin:0; }

    .uploader {
      border:2px dashed var(--border); border-radius:24px;
      padding:40px 24px; text-align:center; transition:.2s; background:#f9fafb;
    }
    .uploader:hover { border-color:#93c5fd; background:#f0f9ff; }
    .uploader .logo { width:64px; height:64px; object-fit:contain; opacity:.95; display:block; margin:0 auto 12px; }
    .uploader .headline { font-size:18px; font-weight:700; }
    .uploader .sub { font-size:14px; color:var(--muted); margin-top:6px; }
    .picked { font-size:14px; margin-top:10px; color:#111827; display:none; }
    .picked strong { font-weight:800; }

    .roles-title { text-align:center; font-weight:800; margin-top:22px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:820px){ .roles-grid{grid-template-columns:repeat(3,1fr);} }
    .role {
      border:1px solid var(--border); border-radius:16px; padding:16px; cursor:pointer;
      background:#fff; transition:.15s; font-size:16px; font-weight:800; text-transform:uppercase;
    }
    .role:hover { box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .role.active { border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,.25); }

    .actions { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .btn { border:0; border-radius:14px; padding:12px 20px; background:var(--brand); color:#fff; font-weight:800; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .link { display:inline-block; border:1px solid var(--border); border-radius:14px; padding:10px 16px; text-decoration:none; color:inherit; }

    .loading { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .result { margin-top:18px; text-align:center; }
    .result img { width:100%; max-width:860px; border-radius:18px; border:1px solid var(--border); }

    footer { margin-top:24px; text-align:center; color:#6b7280; font-size:14px; }
    .err { color:#dc2626; font-size:14px; display:none; white-space:pre-wrap; }
    .tiny { font-size:12px; color:#6b7280; display:none; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1 class="title">Почувствуй себя журналистом</h1></header>

    <div class="uploader" id="dropzone">
      <img class="logo" src="logo.png" alt="Логотип" onerror="this.style.display='none'">
      <div class="headline">Загрузите фото</div>
      <div class="sub">JPG, PNG, WEBP (до 12 МБ)</div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <div id="picked" class="picked"></div>
    </div>

    <section class="roles">
      <div class="roles-title">Выберите роль</div>
      <div class="roles-grid">
        <button class="role" data-role="журналист">Журналист</button>
        <button class="role" data-role="блогер">Блогер</button>
        <button class="role" data-role="фотограф">Фотограф</button>
      </div>
    </section>

    <div class="actions">
      <button id="genBtn" class="btn" disabled>Сгенерировать образ</button>
      <div id="loading" class="loading" style="display:none"><span class="spinner"></span><span>Обрабатываем…</span></div>
      <a id="download" class="link" download="result.png" style="display:none">Скачать PNG</a>
      <div id="error" class="err"></div>
      <div id="debug" class="tiny"></div>
    </div>

    <div class="result" id="resultBox" style="display:none;">
      <img id="resultImg" alt="Результат" />
    </div>
  </div>

  <footer>© 2025 факультет журналистики МГУ</footer>

  <!-- предзагрузка лого для канваса -->
  <img id="logoPreload" src="logo.png?v=1" alt="" style="display:none" crossorigin="anonymous" />

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev"; // твой worker
const LOGO_URL = "logo.png?v=1";
const MAX_FILE_MB = 12;

let file = null, role = null;

const input = document.getElementById('fileInput');
const drop = document.getElementById('dropzone');
const picked = document.getElementById('picked');
const btn = document.getElementById('genBtn');
const loading = document.getElementById('loading');
const resultBox = document.getElementById('resultBox');
const resultImg = document.getElementById('resultImg');
const download = document.getElementById('download');
const err = document.getElementById('error');
const debugBox = document.getElementById('debug');

drop.addEventListener('click', ()=>input.click());
input.addEventListener('change', e => onFile(e.target.files?.[0]));
drop.addEventListener('dragover', e => e.preventDefault());
drop.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f) onFile(f); });

function showErr(m){ err.style.display='block'; err.textContent=m; }
function hideErr(){ err.style.display='none'; err.textContent=''; }
function showLoading(s){ loading.style.display=s?'flex':'none'; }
function logDebug(s){ debugBox.style.display='block'; debugBox.textContent = s; console.log('[debug]', s); }

function onFile(f){
  if (!f) return;
  if (!f.type.startsWith('image/')) return showErr("Нужен файл изображения.");
  if (f.size > MAX_FILE_MB*1048576) return showErr("Слишком большой файл (до 12 МБ).");
  file=f;
  picked.style.display='block';
  picked.innerHTML = `✅ <strong>Вы выбрали:</strong> ${f.name} (${(f.size/1048576).toFixed(1)} МБ)`;
  btn.disabled = !role;
  hideErr();
  resultBox.style.display='none'; resultImg.removeAttribute('src'); download.style.display='none';
}

document.querySelectorAll('.role').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.role').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  role=b.dataset.role;
  btn.disabled = !file;
}));

const fileToB64=(f)=>new Promise((res,rej)=>{
  const r=new FileReader(); r.onload=()=>res(String(r.result).split(',')[1]||''); r.onerror=()=>rej(new Error("Не удалось прочитать файл")); r.readAsDataURL(f);
});
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const img=new Image(); img.crossOrigin='anonymous';
    img.onload=()=>resolve(img); img.onerror=()=>reject(new Error("Не удалось загрузить: "+src));
    img.src = src.includes("?") ? src : (src + "?v=" + Date.now());
  });
}
function expandBox(box, scale){ // чуть больше головы + шея
  const cx = box.x + box.w/2, cy = box.y + box.h/2;
  const nw = Math.min(1, box.w * scale), nh = Math.min(1, box.h * scale * 1.25);
  let nx = cx - nw/2, ny = cy - nh/2;
  if (nx < 0) nx = 0; if (ny < 0) ny = 0;
  if (nx + nw > 1) nx = 1 - nw; if (ny + nh > 1) ny = 1 - nh;
  return { x: nx, y: ny, w: nw, h: nh };
}

// чёрное = НЕ редактировать / тут: берём оригинал лица и мягко кладём поверх
async function composeFaceAndLogo(genB64, srcB64, bbox){
  const genImg = await loadImage("data:image/png;base64,"+genB64);
  const srcImg = await loadImage("data:image/png;base64,"+srcB64);

  const W=genImg.width, H=genImg.height;
  const c=document.createElement("canvas"); c.width=W; c.height=H;
  const ctx=c.getContext("2d");
  ctx.drawImage(genImg,0,0,W,H);

  if (bbox){
    const big = expandBox(bbox, 1.9);
    const dx=Math.round(big.x*W), dy=Math.round(big.y*H);
    const dw=Math.round(big.w*W), dh=Math.round(big.h*H);

    const sx=Math.round(big.x*srcImg.width);
    const sy=Math.round(big.y*srcImg.height);
    const sw=Math.round(big.w*srcImg.width);
    const sh=Math.round(big.h*srcImg.height);

    // лицо из оригинала
    const face=document.createElement("canvas"); face.width=dw; face.height=dh;
    const fctx=face.getContext("2d"); fctx.drawImage(srcImg, sx, sy, sw, sh, 0, 0, dw, dh);

    // радиальный soft-mask
    const mask=document.createElement("canvas"); mask.width=dw; mask.height=dh;
    const mctx=mask.getContext("2d");
    const r=Math.min(dw,dh);
    const grad=mctx.createRadialGradient(dw/2, dh*0.52, r*0.28, dw/2, dh*0.52, r*0.50);
    grad.addColorStop(0,"rgba(0,0,0,1)");
    grad.addColorStop(1,"rgba(0,0,0,0)");
    mctx.fillStyle=grad; mctx.fillRect(0,0,dw,dh);

    ctx.save();
    ctx.drawImage(face, dx, dy, dw, dh);
    ctx.globalCompositeOperation='destination-in';
    ctx.drawImage(mask, dx, dy);
    ctx.restore();
  }

  // логотип
  try{
    let logo = document.getElementById('logoPreload');
    if (!logo || !logo.naturalWidth) logo = await loadImage(LOGO_URL);
    const margin = Math.round(Math.min(W,H)*0.02);
    const targetW = Math.round(W * 0.16);
    const ratio = (logo.naturalWidth||logo.width)/(logo.naturalHeight||logo.height);
    const targetH = Math.round(targetW/ratio);
    const x = W - targetW - margin, y = H - targetH - margin;

    // белая подложка со скруглением
    const pad = Math.round(targetW * 0.10);
    const bx = x - pad, by = y - pad, bw = targetW + pad*2, bh = targetH + pad*2;
    const rad = Math.round(Math.min(bw,bh)*0.18);
    ctx.save();
    roundRect(ctx, bx, by, bw, bh, rad);
    ctx.fillStyle = "rgba(255,255,255,0.94)";
    ctx.fill();
    ctx.restore();

    ctx.globalAlpha = 0.98;
    ctx.drawImage(logo, x, y, targetW, targetH);
    ctx.globalAlpha = 1;
  }catch(e){ console.warn("Logo overlay failed:", e.message); }

  return c.toDataURL("image/png");
}
function roundRect(ctx, x, y, w, h, r){
  r = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

btn.addEventListener('click', async ()=>{
  hideErr(); showLoading(true); btn.disabled=true;
  resultBox.style.display='none'; resultImg.removeAttribute('src'); download.style.display='none';

  try{
    if (!/^https?:\/\//i.test(API_BASE)) throw new Error("API не настроено.");
    if (!file || !role) throw new Error("Загрузите фото и выберите роль.");

    // читаем исходник (для detect-face + последующей склейки лица)
    const srcB64 = await fileToB64(file);

    // 1) bbox
    let bbox = null;
    try{
      const fdD = new FormData(); fdD.append("image_b64", srcB64);
      const rD = await fetch(API_BASE + "/api/detect-face", { method:"POST", body: fdD });
      const jD = await rD.json();
      bbox = jD?.face?.box || null;
      if (!bbox) throw new Error();
    }catch{
      // подсказка пользователю (но продолжаем — просто без возврата лица)
      logDebug("Не удалось найти лицо. Попробуйте фото фронтально/чуть крупнее.");
    }

    // 2) generate через Gemini (на воркере)
    const fd = new FormData();
    fd.append("role", role);
    fd.append("image_b64", srcB64);

    const rG = await fetch(API_BASE + "/api/generate", { method:"POST", body: fd });
    const raw = await rG.text();
    if (!rG.ok) {
      let msg = "Ошибка генерации";
      try { const jj = JSON.parse(raw); msg = (jj.error || msg) + (jj.details ? ("\n"+jj.details) : ""); } catch {}
      throw new Error(msg);
    }
    const jG = JSON.parse(raw);
    if (!jG?.imageBase64) throw new Error("Пустой ответ API");

    // 3) пост-склейка лица + логотип
    const finalUrl = await composeFaceAndLogo(jG.imageBase64, srcB64, bbox || null);

    resultImg.src = finalUrl;
    resultBox.style.display = 'block';
    download.href = finalUrl;
    download.style.display = 'inline-block';
  }catch(e){
    showErr(e.message || String(e));
  }finally{
    showLoading(false);
    btn.disabled=false;
  }
});
</script>
</body>
</html>

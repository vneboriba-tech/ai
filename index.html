<script>
/* ===== CONFIG ===== */
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev"; // "" если UI и API на одном домене
const LOGO_URL = "logo.png?v=1";
const MAX_UPLOAD_MB = 12;
const MAX_SIDE = 1024;
const PAYLOAD_LIMIT_BYTES = 4.2 * 1024 * 1024; // безопасный лимит < 4.5 МБ для Workers AI

/* ===== STATE / DOM ===== */
let file = null, role = null;
const input = document.getElementById('fileInput');
const drop = document.getElementById('dropzone');
const picked = document.getElementById('picked');
const btn = document.getElementById('genBtn');
const loading = document.getElementById('loading');
const resultBox = document.getElementById('resultBox');
const resultImg = document.getElementById('resultImg');
const download = document.getElementById('download');
const err = document.getElementById('error');

/* ===== Uploader ===== */
drop.addEventListener('click', ()=>input.click());
drop.addEventListener('dragover', e => e.preventDefault());
drop.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f) onFile(f); });
input.addEventListener('change', e => onFile(e.target.files?.[0]));

function onFile(f){
  if (!f) return;
  if (!(f.type||"").startsWith('image/')) return showErr("Нужен файл изображения.");

  const t = (f.type || "").toLowerCase();
  const name = (f.name || "").toLowerCase();
  if (t.includes("heic") || t.includes("heif") || name.endsWith(".heic") || name.endsWith(".heif"))
    return showErr("HEIC/HEIF не поддерживается. Сохраните фото как JPG/PNG.");

  if (f.size > MAX_UPLOAD_MB*1024*1024) return showErr(`Слишком большой файл (до ${MAX_UPLOAD_MB} МБ).`);
  file = f;
  picked.textContent = `Вы выбрали: ${f.name}`;
  btn.disabled = !(file && role);
  hideErr();
}

document.querySelectorAll('.role').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('.role').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  role = b.dataset.role;
  btn.disabled = !(file && role);
}));

/* ===== Helpers ===== */
function showErr(m){ err.style.display='block'; err.innerText = m; }
function hideErr(){ err.style.display='none'; err.innerText=""; }
function showLoading(s){ loading.style.display = s ? 'flex' : 'none'; }

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const img=new Image(); img.crossOrigin="anonymous";
    img.onload=()=>resolve(img);
    img.onerror=()=>reject(new Error("Load failed"));
    img.src = src.includes("data:") ? src : (src + "?v=" + Date.now());
  });
}

function b64Bytes(b64){
  const L = b64.length;
  return Math.floor((L * 3) / 4) - (b64.endsWith("==") ? 2 : b64.endsWith("=") ? 1 : 0);
}

// оптимизированный ресайз + сжатие под лимит Workers AI
async function fileToResizedB64(file){
  const dataUrl = await new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result); r.onerror=()=>rej(new Error("Ошибка чтения файла"));
    r.readAsDataURL(file);
  });
  const img = await loadImage(dataUrl);

  let W = img.naturalWidth, H = img.naturalHeight;
  let scale = Math.max(W,H) > MAX_SIDE ? MAX_SIDE / Math.max(W,H) : 1;
  W = Math.round(W * scale); H = Math.round(H * scale);

  let c=document.createElement('canvas'); c.width=W; c.height=H;
  let ctx=c.getContext('2d'); ctx.imageSmoothingQuality='high';
  ctx.drawImage(img,0,0,W,H);

  let quality=0.9, b64=c.toDataURL('image/jpeg', quality).split(',')[1];
  while (b64Bytes(b64) > PAYLOAD_LIMIT_BYTES && (quality>0.5 || W>512)) {
    if (quality>0.6) quality-=0.1;
    else {
      W=Math.round(W*0.9); H=Math.round(H*0.9);
      const c2=document.createElement('canvas'); c2.width=W; c2.height=H;
      const ctx2=c2.getContext('2d'); ctx2.imageSmoothingQuality='high';
      ctx2.drawImage(img,0,0,W,H);
      c=c2; ctx=ctx2;
    }
    b64=c.toDataURL('image/jpeg', quality).split(',')[1];
  }
  return b64;
}

// создаём маску для лица/шеи
async function buildFaceNeckMaskForB64(b64){
  const img = await loadImage("data:image/jpeg;base64,"+b64);
  const W=img.width,H=img.height;
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  const cx=W/2, cy=H*0.45, rx=W*0.25, ry=H*0.4;
  ctx.beginPath(); ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); ctx.closePath();
  ctx.fillStyle="#000"; ctx.fill();
  return c.toDataURL('image/png').split(',')[1];
}

// лого
function toCanvasWithLogo(baseImg,logoImg){
  const W=baseImg.width,H=baseImg.height;
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.drawImage(baseImg,0,0,W,H);
  const targetW=W*0.18, targetH=targetW*(logoImg.height/logoImg.width);
  ctx.globalAlpha=0.97;
  ctx.drawImage(logoImg,W-targetW-20,H-targetH-20,targetW,targetH);
  ctx.globalAlpha=1;
  return c.toDataURL('image/png');
}
async function addLogoToBase64(b64){
  try{
    const base=await loadImage("data:image/png;base64,"+b64);
    const logo=document.getElementById('logoPreload');
    return toCanvasWithLogo(base,logo);
  }catch{return "data:image/png;base64,"+b64;}
}

/* ===== Generate ===== */
btn.addEventListener('click', async ()=>{
  hideErr(); showLoading(true); btn.disabled=true;
  resultBox.style.display='none'; resultImg.removeAttribute('src'); download.style.display='none';
  try{
    if (!file||!role) throw new Error("Загрузите фото и выберите роль.");

    const b64=await fileToResizedB64(file);
    const maskB64=await buildFaceNeckMaskForB64(b64);

    const fd=new FormData();
    fd.append("role",role);
    fd.append("image_b64",b64);
    fd.append("mask_b64",maskB64);
    fd.append("max_steps","18"); // фикс для JSON ошибок

    const resp=await fetch(`${API_BASE}/api/generate`,{method:"POST",body:fd});
    const txt=await resp.text();
    let data; try{data=JSON.parse(txt);}catch{throw new Error("Неверный ответ от сервера: "+txt.slice(0,200));}

    if(!resp.ok) throw new Error(data?.details||data?.error||"Ошибка генерации");
    if(!data?.imageBase64) throw new Error("Пустой ответ модели");

    const finalUrl=await addLogoToBase64(data.imageBase64);
    resultImg.src=finalUrl;
    resultBox.style.display='block';
    download.href=finalUrl;
    download.style.display='inline-block';
  }catch(e){ showErr(e.message); }
  finally{ showLoading(false); btn.disabled=!(file&&role); }
});
</script>

// Cloudflare Worker — Workers AI Inpainting, r7
// Модель: @cf/runwayml/stable-diffusion-v1-5-inpainting
// Маска: БЕЛОЕ = менять (фон/реквизит), ЧЁРНОЕ = сохранить (человек).
// Усилен prompt для роли; поднята сила до 0.65 (фон только по маске).

const VERSION = "workers-ai-inpaint-2025-10-21r7";

function cors(req){return{
  "Access-Control-Allow-Origin": req.headers.get("Origin") || "*",
  "Vary": "Origin",
  "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
  "Access-Control-Allow-Headers": req.headers.get("Access-Control-Request-Headers") || "Content-Type",
  "Access-Control-Max-Age": "86400",
};}
function json(req, body, status=200){
  return new Response(JSON.stringify(body), {
    status,
    headers: { "Content-Type": "application/json; charset=utf-8", ...cors(req) }
  });
}
const stripDataUrl = s => String(s||"").replace(/^data:image\/[a-zA-Z0-9.+-]+;base64,/, "");
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

async function b64ToUint8(b64){
  const bin = atob(b64);
  const buf = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) buf[i] = bin.charCodeAt(i);
  return buf;
}
async function uint8ToB64(u8){
  let bin = "";
  for (let i=0;i<u8.length;i++) bin += String.fromCharCode(u8[i]);
  return btoa(bin);
}

function normRole(r){ r=(r||"").toLowerCase();
  if (r.includes("блог")) return "блогер";
  if (r.includes("фот")) return "фотограф";
  return "журналист";
}
function rolePrompt(role){
  if (role==="журналист")
    return "TV news studio background with video walls showing headlines, newsroom monitors, glass anchor desk in the foreground and several microphones on stands slightly out of focus; cinematic editorial lighting; photorealistic; no text overlay";
  if (role==="блогер")
    return "creator studio background with ring light, camera on tripod, softbox lights, décor shelves and a subtle neon sign; clean bright look; photorealistic; no text overlay";
  if (role==="фотограф")
    return "professional photo studio background with backdrops, C-stands, softboxes and camera gear; moody studio light; photorealistic; no text overlay";
  return "neutral professional studio background; photorealistic; no text overlay";
}

export default {
  async fetch(req, env){
    if (req.method === "OPTIONS")
      return new Response(null, { status:204, headers: cors(req) });

    const url  = new URL(req.url);
    const path = (url.pathname||"/").replace(/\/{2,}/g,"/").replace(/\/+$/,"") || "/";

    if (req.method==="GET" && path==="/api/debug"){
      return json(req, {
        ok: true,
        version: VERSION,
        workersAI: !!env.AI,
        model: "@cf/runwayml/stable-diffusion-v1-5-inpainting",
        expected: "POST /api/safe-edit"
      });
    }

    if (req.method==="GET" && path==="/"){
      return json(req, { ok:true, version:VERSION, expected:"POST /api/safe-edit" });
    }

    if (req.method==="POST" && path==="/api/safe-edit"){
      if (!env.AI) return json(req, { error:"no-workers-ai-binding" }, 500);

      try{
        const form = await req.formData();
        const roleIn   = String(form.get("role") || "журналист");
        const role     = normRole(roleIn);
        const promptIn = String(form.get("prompt") || "") || rolePrompt(role);

        const imgB64   = form.get("image_b64") || form.get("image");
        const maskB64  = form.get("mask_b64")  || form.get("mask");
        if (!imgB64)  return json(req, { error:"no-image" }, 400);
        if (!maskB64) return json(req, { error:"no-mask" }, 400);

        const guidanceIn = Number(form.get("guidance") ?? 8.0);
        const stepsIn    = Number(form.get("num_steps") ?? 20);
        const strengthIn = Number(form.get("strength") ?? 0.65); // фон выраженнее

        const guidance = clamp(isFinite(guidanceIn)?guidanceIn:8.0, 1.0, 12.0);
        const num_steps = clamp(isFinite(stepsIn)?stepsIn:20, 1, 20);
        const strength  = clamp(isFinite(strengthIn)?strengthIn:0.65, 0.3, 0.85);

        const imageBytes = await b64ToUint8(stripDataUrl(String(imgB64)));
        const maskBytes  = await b64ToUint8(stripDataUrl(String(maskB64)));

        const model = "@cf/runwayml/stable-diffusion-v1-5-inpainting";
        const payload = {
          prompt: promptIn,
          negative_prompt: "text, watermark, logo, artifacts, glitch, cartoon",
          image: [...imageBytes],
          mask:  [...maskBytes], // WHITE=change (background/props), BLACK=keep (person)
          guidance,
          num_steps,
          strength
        };

        let out;
        try { out = await env.AI.run(model, payload); }
        catch (e) { return json(req, { error:"workers-ai-failed", details:String(e?.message||e), used:{ guidance, num_steps, strength, model } }, 502); }

        try {
          const resp = new Response(out, { headers: { "content-type": "image/png" }});
          const buf = await resp.arrayBuffer();
          const b64 = await uint8ToB64(new Uint8Array(buf));
          return json(req, {
            imageBase64: b64,
            modelUsed: model,
            stage: "workers-ai-inpaint",
            used: { guidance, num_steps, strength }
          }, 200);
        } catch (e) {
          return json(req, { error:"unexpected-workers-ai-output", details:String(e?.message||e) }, 502);
        }

      }catch(e){
        return json(req, { error:"safe-edit-failed", details:String(e?.message||e) }, 502);
      }
    }

    return json(req, { error:"not-found", path, method:req.method }, 404);
  }
};

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Медиастарт 2025/2026 — Face-lock генерация</title>
  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f9f9fb;
      color: #111;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      margin: 30px auto 20px;
    }
    header img {
      width: 200px;
      height: auto;
    }
    h1 {
      font-size: 1.3rem;
      margin: 15px 0;
      font-weight: 600;
    }
    .box {
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 25px;
    }
    input, select, button {
      width: 100%;
      font-size: 1rem;
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #0066ff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .secondary {
      background: #555;
    }
    .result {
      margin-top: 20px;
    }
    .result img {
      width: 100%;
      border-radius: 16px;
      margin-top: 10px;
    }
    footer {
      margin: 40px auto;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <img src="Почувствуй себя журналистом.png" alt="Медиастарт">
  </header>
  <div class="box">
    <h1>Почувствуй себя журналистом МГУ</h1>
    <input type="file" id="photo" accept="image/*" />
    <select id="role">
      <option value="журналист">Журналист</option>
      <option value="блогер">Блогер</option>
      <option value="фотограф">Фотограф</option>
    </select>
    <button id="generateBtn">Сгенерировать образ</button>
    <button id="downloadBtn" class="secondary" disabled>Скачать PNG</button>
    <p id="status"></p>
    <div class="result" id="resultBox"></div>
  </div>
  <footer>
    факультет журналистики МГУ<br/>
    © 2025 с любовью KM™
  </footer>

  <script>
  const apiBase = "https://<твой-worker-с-доменом>.workers.dev"; // ⚠️ подставь URL воркера

  const photoInput = document.getElementById("photo");
  const roleSel = document.getElementById("role");
  const generateBtn = document.getElementById("generateBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const statusEl = document.getElementById("status");
  const resultBox = document.getElementById("resultBox");

  let generatedB64 = "";

  generateBtn.onclick = async () => {
    const file = photoInput.files[0];
    if (!file) return alert("Выберите фото!");

    generateBtn.disabled = true;
    statusEl.textContent = "Определяем лицо и пол...";

    const b64 = await fileToBase64(file);

    // 1. Детектим лицо
    const face = await postJson("/api/detect-face", { image_b64: b64 });
    const box = face?.face?.box;
    // создаем маску: чёрная область — лицо, белый фон
    let maskB64 = "";
    if (box) maskB64 = makeMask(box, 512, 512);

    // 2. Определяем пол
    const g = await postJson("/api/gender", { image_b64: b64 });
    const gender = g?.gender || "neutral";

    // 3. Генерация
    statusEl.textContent = "Генерация...";
    const fd = new FormData();
    fd.append("image_b64", b64);
    fd.append("mask_b64", maskB64);
    fd.append("role", roleSel.value);
    fd.append("gender", gender);
    fd.append("want_w", 512);
    fd.append("want_h", 512);

    const gen = await fetch(apiBase + "/api/generate", { method:"POST", body: fd });
    const j = await gen.json();
    if (j.imageBase64) {
      generatedB64 = j.imageBase64;
      resultBox.innerHTML = `<h3>Результат</h3><img src="data:image/png;base64,${generatedB64}" />`;
      downloadBtn.disabled = false;
      statusEl.textContent = "✅ Готово!";
    } else {
      statusEl.textContent = "Ошибка генерации: " + (j.error || "");
      console.error(j);
    }
    generateBtn.disabled = false;
  };

  downloadBtn.onclick = () => {
    if (!generatedB64) return;
    const a = document.createElement("a");
    a.href = "data:image/png;base64," + generatedB64;
    a.download = "mediastart.png";
    a.click();
  };

  async function postJson(path, bodyObj) {
    const fd = new FormData();
    for (const k in bodyObj) fd.append(k, bodyObj[k]);
    const res = await fetch(apiBase + path, { method:"POST", body: fd });
    return await res.json();
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function makeMask(box, w, h) {
    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(0,0,w,h);
    const cx = box.x * w + box.w * w / 2;
    const cy = box.y * h + box.h * h / 2;
    const rx = (box.w * w) / 1.7;
    const ry = (box.h * h) / 1.5;
    ctx.fillStyle = "#000000";
    ctx.beginPath();
    ctx.ellipse(cx, cy, rx, ry, 0, 0, 2*Math.PI);
    ctx.fill();
    return canvas.toDataURL("image/png").split(",")[1];
  }
  </script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Почувствуй себя журналистом</title>
  <meta name="description" content="Журналист / Блогер / Фотограф — жёсткая смена фона и мягкая смена одежды с сохранением лица и рук" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial;}
    body { display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { text-align:center; margin-top:24px; margin-bottom:16px; }
    h1 { font-size:clamp(28px,4vw,42px); margin:0; font-weight:800; }
    .container { width:100%; max-width:960px; padding:20px; }
    .uploader { border:2px dashed var(--border); border-radius:24px; padding:40px 20px; background:#f9fafb; text-align:center; cursor:pointer; transition:.2s; }
    .uploader:hover { border-color:var(--accent); background:#f0f9ff; }
    .uploader img.logo { width:72px; height:72px; margin-bottom:12px; }
    .headline { font-weight:700; font-size:18px; }
    .sub { color:var(--muted); font-size:14px; margin-top:6px; }
    .picked { margin-top:10px; font-size:14px; }
    .roles { margin-top:24px; }
    .roles-title { text-align:center; font-weight:700; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:720px){ .roles-grid{grid-template-columns:repeat(3,1fr);} }
    .role { border:1px solid var(--border); border-radius:14px; padding:12px; font-weight:700; cursor:pointer; background:#fff; transition:.15s; }
    .role:hover { box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .role.active { border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.2); }
    .status { margin-top:20px; text-align:center; font-size:15px; white-space:pre-wrap; }
    .err { color:#dc2626; font-size:14px; text-align:center; margin-top:10px; display:none; white-space:pre-wrap; }
    .result { margin-top:24px; text-align:center; }
    .result img { width:100%; max-width:800px; border-radius:18px; border:1px solid var(--border); }
    .btn { background:#10b981; color:#fff; padding:10px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:700; }
    .btn:hover { background:#059669; }
    footer { margin-top:40px; text-align:center; color:#6b7280; font-size:14px; }
    pre#logs { text-align:left; background:#0b1020; color:#cbd5e1; padding:12px; border-radius:12px; overflow:auto; max-height:260px; font-size:12px; display:none; }
  </style>
  <!-- TF.js + BodyPix -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Почувствуй себя журналистом</h1></header>

    <div class="uploader" id="dropzone">
      <img src="logo.png" alt="Логотип" class="logo" onerror="this.style.display='none'">
      <div class="headline">Загрузите фото</div>
      <div class="sub">JPG, PNG, WEBP до 12 МБ</div>
      <input id="fileInput" type="file" accept="image/jpeg,image/png,image/webp" style="display:none" />
      <div id="picked" class="picked"></div>
    </div>

    <div class="roles">
      <div class="roles-title">Выберите роль</div>
      <div class="roles-grid">
        <button class="role active" data-role="журналист">Журналист</button>
        <button class="role" data-role="блогер">Блогер</button>
        <button class="role" data-role="фотограф">Фотограф</button>
      </div>
    </div>

    <div id="status" class="status">Готово к работе</div>
    <div id="error" class="err"></div>

    <div id="resultBox" class="result" style="display:none;">
      <img id="resultImg" alt="Результат">
      <div style="margin-top:12px;">
        <a id="download" class="btn" download="result.png" style="display:none;">Скачать PNG</a>
      </div>
    </div>

    <pre id="logs"></pre>
  </div>

  <footer>© 2025 факультет журналистики МГУ</footer>

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
const MAX_MB = 12;
const MAX_SIZE = 1024;

let file=null, role="журналист", bp=null;

const CLOTH_STRENGTH = 0.35; // мягкая смена одежды

const input = document.getElementById("fileInput");
const drop  = document.getElementById("dropzone");
const picked= document.getElementById("picked");
const statusEl=document.getElementById("status");
const errEl=document.getElementById("error");
const resultBox=document.getElementById("resultBox");
const resultImg=document.getElementById("resultImg");
const download=document.getElementById("download");
const logsEl=document.getElementById("logs");

function showErr(m){ errEl.style.display="block"; errEl.innerText=m; statusEl.innerText="Ошибка"; }
function hideErr(){ errEl.style.display="none"; errEl.innerText=""; }
function log(o){ try{ logsEl.style.display="block"; logsEl.textContent=typeof o==="string"?o:JSON.stringify(o,null,2);}catch{} }
function fetchTO(url, init={}, ms=120000){ const c=new AbortController(); const id=setTimeout(()=>c.abort(),ms); return fetch(url,{...init,signal:c.signal}).finally(()=>clearTimeout(id)); }

drop.addEventListener("click",()=>input.click());
drop.addEventListener("dragover",e=>e.preventDefault());
drop.addEventListener("drop",e=>{e.preventDefault();const f=e.dataTransfer.files?.[0];if(f)handleFile(f);});
input.addEventListener("change",e=>handleFile(e.target.files?.[0]));

document.querySelectorAll(".role").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".role").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    role=b.dataset.role;
    if (file) generate();
  });
});

function loadImg(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function loadBP(){ if (bp) return bp; statusEl.innerText="Загрузка сегментации…"; bp=await bodyPix.load({architecture:"MobileNetV1", outputStride:16, multiplier:0.75, quantBytes:2}); return bp; }

function handleFile(f){
  if (!f) return;
  if (!f.type.startsWith("image/")) return showErr("Нужен файл изображения.");
  if (f.size>MAX_MB*1024*1024) return showErr("Слишком большой файл (до 12 МБ).");
  hideErr(); file=f; picked.innerText=`Вы выбрали: ${f.name}`; generate();
}

async function resizeFile(f){
  const du=await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});
  const im=await loadImg(du); let w=im.width,h=im.height,k=Math.max(w,h)>MAX_SIZE?MAX_SIZE/Math.max(w,h):1;
  w=Math.round(w*k); h=Math.round(h*k);
  const c=document.createElement("canvas"); c.width=w; c.height=h; c.getContext("2d").drawImage(im,0,0,w,h);
  const out=c.toDataURL("image/jpeg",0.92);
  return {w,h, dataUrl:out, b64:out.split(",")[1]};
}

/* Строим 3 слоя:
   - mattePerson (альфа всей фигуры) — для вырезания и наложения на фон
   - matteHeadHands — для защиты головы и кистей
   - matteBodyOnly — одежда без головы/кистей (для wardrobe)
*/
async function buildMattes(dataUrl){
  const model=await loadBP(); const img=await loadImg(dataUrl);
  const w=img.width,h=img.height;

  const person=await model.segmentPerson(img,{internalResolution:'medium',segmentationThreshold:0.7});
  const parts =await model.segmentPersonParts(img,{internalResolution:'medium',segmentationThreshold:0.7});

  const HEAD=new Set([0,1]); // face, hair
  const ARMS=new Set([2,3,4,5]); // руки

  const makeCanvas=(alphaField)=>{
    const c=document.createElement("canvas"); c.width=w; c.height=h;
    const g=c.getContext("2d"); const id=g.createImageData(w,h);
    for(let i=0;i<w*h;i++){ const a=alphaField[i]|0; id.data[i*4+3]=a; }
    g.putImageData(id,0,0); return c;
  };

  // mattePerson
  const personA=new Uint8ClampedArray(w*h);
  for(let i=0;i<w*h;i++){ personA[i]=person.data[i]===1?255:0; }
  const cPerson=makeCanvas(personA);
  // размытие края
  const cPersonB=document.createElement("canvas"); cPersonB.width=w;cPersonB.height=h;
  const gb=cPersonB.getContext("2d"); gb.filter="blur(4px)"; gb.drawImage(cPerson,0,0);

  // head+hands
  const hhA=new Uint8ClampedArray(w*h);
  for(let i=0;i<w*h;i++){ const pid=parts.data[i]; hhA[i]=(HEAD.has(pid)||ARMS.has(pid))?255:0; }
  const cHH=makeCanvas(hhA); const cHHB=document.createElement("canvas"); cHHB.width=w;cHHB.height=h; const ghh=cHHB.getContext("2d"); ghh.filter="blur(6px)"; ghh.drawImage(cHH,0,0);

  // bodyOnly = person - head&hands
  const bodyA=new Uint8ClampedArray(w*h);
  for(let i=0;i<w*h;i++){ bodyA[i]=(personA[i] && !hhA[i])?255:0; }
  const cBody=makeCanvas(bodyA); const cBodyB=document.createElement("canvas"); cBodyB.width=w;cBodyB.height=h; const gbod=cBodyB.getContext("2d"); gbod.filter="blur(5px)"; gbod.drawImage(cBody,0,0);

  // превратим в PNG-слои
  const base=await loadImg(dataUrl);
  const cut = (maskCanvas)=>{ const cv=document.createElement("canvas"); cv.width=w; cv.height=h; const g=cv.getContext("2d"); g.drawImage(base,0,0,w,h); g.globalCompositeOperation="destination-in"; g.drawImage(maskCanvas,0,0,w,h); g.globalCompositeOperation="source-over"; return cv.toDataURL("image/png").split(",")[1]; };

  return {
    mattePerson_b64: cPersonB.toDataURL("image/png").split(",")[1],
    headHands_png_b64: cut(cHHB),
    bodyOnly_mask_b64: cBodyB.toDataURL("image/png").split(",")[1]
  };
}

function bgPrompt(role){
  if (role==="журналист") return "wide TV newsroom background: broadcast cameras, boom microphones, glass anchor desk, video walls with abstract news graphics; cinematic editorial lighting; photorealistic; no readable text";
  if (role==="блогер")    return "trendy creator studio background: ring light, green screen, camera on tripod, softbox lights, colorful LED accents, cozy décor; photorealistic; no readable text";
  if (role==="фотограф")  return "professional photography studio background: backdrop rolls, C-stands, softboxes, light stands, camera gear; moody studio lighting; photorealistic; no readable text";
  return "neutral professional studio background; photorealistic; no text";
}
function outfitPrompt(role){
  if (role==="журналист") return "update ONLY clothing to smart-casual journalist style: blazer or tailored jacket over the current outfit, neutral tones; keep the same person and identity; photorealistic";
  if (role==="блогер")    return "update ONLY clothing to stylish casual blogger style: light hoodie or tee, denim or relaxed trousers; keep the same person and identity; photorealistic";
  if (role==="фотограф")  return "update ONLY clothing to practical photographer style: dark utility vest or jacket; keep the same person and identity; photorealistic";
  return "subtle outfit update; keep identity";
}

/* логотип-оверлей */
async function composeLogoOver(imgDataUrl){
  const base = await loadImg(imgDataUrl);
  const logo = await loadImg("logo.png").catch(()=>null);
  if (!logo) return imgDataUrl;
  const w=base.width,h=base.height;
  const c=document.createElement("canvas"); c.width=w; c.height=h; const g=c.getContext("2d");
  g.drawImage(base,0,0,w,h);
  const logoW=Math.max(120,Math.round(w*0.16)); const scale=logoW/logo.width; const logoH=Math.round(logo.height*scale);
  const pad=Math.max(16,Math.round(Math.min(w,h)*0.02)); const x=w-logoW-pad; const y=h-logoH-pad;
  g.fillStyle="rgba(255,255,255,0.85)"; const br=Math.round(logoH*0.18);
  g.beginPath(); g.moveTo(x+br,y); g.arcTo(x+logoW,y,x+logoW,y+logoH,br); g.arcTo(x+logoW,y+logoH,x,y+logoH,br); g.arcTo(x,y+logoH,x,y,br); g.arcTo(x,y,x+logoW,y,br); g.closePath(); g.fill();
  g.drawImage(logo,x,y,logoW,logoH);
  return c.toDataURL("image/png");
}

async function generate(){
  if (!file) return;
  statusEl.innerText="Подготовка…"; resultBox.style.display="none"; download.style.display="none"; hideErr(); logsEl.style.display="none";

  try{
    const resized = await resizeFile(file);
    const {w,h,dataUrl,b64} = resized;

    // 1) генерим фон точного размера на сервере
    statusEl.innerText="Шаг 1/3: генерируем фон…";
    let fd=new FormData();
    fd.append("mode","gen-bg");
    fd.append("width", String(w));
    fd.append("height", String(h));
    fd.append("prompt", bgPrompt(role));
    let r=await fetchTO(`${API_BASE}/api/safe-edit`, { method:"POST", body:fd }, 120000);
    let j=JSON.parse(await r.text());
    log({bg:j});
    if (!r.ok || !j.imageBase64) return showErr(j?.error||"Не удалось создать фон");
    let bgUrl="data:image/png;base64,"+j.imageBase64;

    // 2) строим матты
    statusEl.innerText="Шаг 2/3: сегментация…";
    const { mattePerson_b64, headHands_png_b64, bodyOnly_mask_b64 } = await buildMattes(dataUrl);

    // 3) мягко меняем одежду (img2img по маске bodyOnly)
    statusEl.innerText="Шаг 3/3: обновляем одежду…";
    fd=new FormData();
    fd.append("mode","wardrobe-mask");
    fd.append("image_b64", b64);
    fd.append("mask_b64", bodyOnly_mask_b64);
    fd.append("prompt", outfitPrompt(role));
    fd.append("strength", String(CLOTH_STRENGTH));
    r=await fetchTO(`${API_BASE}/api/safe-edit`, { method:"POST", body:fd }, 120000);
    j=JSON.parse(await r.text());
    log({wardrobe:j});
    const outfitUrl = j?.imageBase64 ? "data:image/png;base64,"+j.imageBase64 : dataUrl;

    // Композиция: фон → вырезанное тело (из outfitUrl с mattePerson) → head+hands из оригинала → лого
    const comp = document.createElement("canvas");
    const bg = await loadImg(bgUrl);
    const bodySrc = await loadImg(outfitUrl);
    const matteP = await loadImg("data:image/png;base64,"+mattePerson_b64);
    const headH  = await loadImg("data:image/png;base64,"+headHands_png_b64);
    comp.width=bg.width; comp.height=bg.height;
    const g=comp.getContext("2d");
    g.drawImage(bg,0,0,bg.width,bg.height);
    // применим матт к телу
    const tmp=document.createElement("canvas"); tmp.width=bg.width; tmp.height=bg.height;
    const gt=tmp.getContext("2d"); gt.drawImage(bodySrc,0,0); gt.globalCompositeOperation="destination-in"; gt.drawImage(matteP,0,0); gt.globalCompositeOperation="source-over";
    g.drawImage(tmp,0,0);
    // голова+кисти
    g.drawImage(headH,0,0);
    let finalUrl = comp.toDataURL("image/png");
    finalUrl = await composeLogoOver(finalUrl);

    resultImg.src=finalUrl; resultBox.style.display="block"; download.href=finalUrl; download.style.display="inline-block";
    statusEl.innerText="Готово ✓ · фон + одежда + защита лица/рук";
  }catch(e){
    showErr(e.message||"Неизвестная ошибка");
  }
}
</script>
</body>
</html>

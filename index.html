<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: #fff; color: #111; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; }
    h1 { margin: 24px 0 8px; font-size: 2rem; }
    .uploader { border:2px dashed #ccc; border-radius:20px; padding:30px; text-align:center; cursor:pointer; max-width:420px; transition:.3s; }
    .uploader:hover { background:#f9f9f9; border-color:#60a5fa; }
    #fileInput { display:none; }
    #pickedName { margin-top:8px; font-size:14px; color:#374151; display:none; }
    button { background:#2563eb; color:#fff; border:none; padding:10px 18px; border-radius:10px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    footer { margin-top:auto; padding:30px; color:#555; font-size:13px; }
    img#resultImg { max-width: 600px; border-radius: 12px; margin-top: 18px; display:none; }
  </style>
</head>
<body>
  <h1>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1>

  <div class="uploader" id="dropzone">
    <div>üì∑ –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</div>
    <div style="font-size:13px;color:#666;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG, WEBP, HEIC</div>
    <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp,image/heic,image/heif" />
    <div id="pickedName"></div>
  </div>

  <div style="margin-top:20px;">
    <button id="genBtn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <div id="loading" style="margin-top:10px; display:none;">‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</div>
  <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />

  <footer>¬© 2025 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</footer>

  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  <script>
    const API_BASE = "https://media-gen-worker.vneboriba.workers.dev/";
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const pickedName = document.getElementById("pickedName");
    const genBtn = document.getElementById("genBtn");
    const loading = document.getElementById("loading");
    const resultImg = document.getElementById("resultImg");
    let pickedFile = null;

    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", e => e.preventDefault());
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      const f = e.dataTransfer.files?.[0];
      if (f) onPick(f);
    });
    fileInput.addEventListener("change", e => {
      const f = e.target.files?.[0];
      if (f) onPick(f);
    });

    function onPick(f) {
      pickedFile = f;
      pickedName.style.display = "block";
      pickedName.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + f.name;
      genBtn.disabled = false;
    }

    async function convertHeic(file) {
      const type = (file.type || "").toLowerCase();
      const name = (file.name || "").toLowerCase();
      if (!(type.includes("heic") || type.includes("heif") || name.endsWith(".heic") || name.endsWith(".heif"))) return file;
      try {
        const outBlob = await heic2any({ blob: file, toType: "image/jpeg" });
        return new File([outBlob], "converted.jpg", { type: "image/jpeg" });
      } catch {
        return file;
      }
    }

    genBtn.addEventListener("click", async () => {
      if (!pickedFile) return;
      genBtn.disabled = true;
      loading.style.display = "block";
      resultImg.style.display = "none";

      const converted = await convertHeic(pickedFile);
      const fd = new FormData();
      fd.append("role", "–∂—É—Ä–Ω–∞–ª–∏—Å—Ç"); // –≤—Ä–µ–º–µ–Ω–Ω–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ
      fd.append("image", converted);

      try {
        const r = await fetch(API_BASE + "api/generate", { method: "POST", body: fd });
        const t = await r.text();
        if (!r.ok) throw new Error(t || "HTTP " + r.status);
        const j = JSON.parse(t);
        if (!j.imageBase64) throw new Error("AI –Ω–µ –≤–µ—Ä–Ω—É–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
        resultImg.src = "data:image/png;base64," + j.imageBase64;
        resultImg.style.display = "block";
      } catch (err) {
        alert("–û—à–∏–±–∫–∞: " + err.message);
      } finally {
        genBtn.disabled = false;
        loading.style.display = "none";
      }
    });
  </script>
</body>
</html>

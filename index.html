<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Почувствуй себя журналистом</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:0;background:#fff;color:#111;display:flex;flex-direction:column;align-items:center}
.container{max-width:960px;width:100%;padding:24px}
h1{text-align:center;font-size:clamp(28px,4vw,42px);font-weight:800;margin:0 0 20px}
.uploader{border:2px dashed #ddd;border-radius:20px;padding:40px 20px;text-align:center;cursor:pointer;background:#fafafa;transition:.2s}
.uploader:hover{background:#f0f9ff;border-color:#2563eb}
.role-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:20px 0}
.role{padding:14px;border:1px solid #ddd;border-radius:12px;cursor:pointer;background:#fff;font-weight:600}
.role.active{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.25)}
.btn{background:#2563eb;color:#fff;border:0;border-radius:12px;padding:12px 20px;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.result img{max-width:100%;border-radius:18px;margin-top:20px;border:1px solid #ddd}
footer{margin-top:40px;color:#666;font-size:14px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <h1>Почувствуй себя журналистом</h1>
  <div class="uploader" id="drop">Загрузите фото<input type="file" id="file" accept="image/*" hidden></div>
  <div class="role-grid">
    <button class="role" data-role="журналист">Журналист</button>
    <button class="role" data-role="блогер">Блогер</button>
    <button class="role" data-role="фотограф">Фотограф</button>
  </div>
  <button id="gen" class="btn" disabled>Сгенерировать</button>
  <div id="error" style="color:#c00;margin-top:10px"></div>
  <div class="result"><img id="out" alt=""></div>
</div>
<footer>© 2025 факультет журналистики МГУ</footer>
<script>
const API="https://media-gen-worker.vneboriba.workers.dev";
let file=null,role=null,faceBox=null,imgEl=null;

function sel(q){return document.querySelector(q)}
function makeMask(img,box){
  const c=document.createElement("canvas");
  c.width=img.naturalWidth;c.height=img.naturalHeight;
  const ctx=c.getContext("2d");
  ctx.fillStyle="black";ctx.fillRect(0,0,c.width,c.height);
  if(box){ctx.fillStyle="white";
    ctx.fillRect(box.x*c.width,box.y*c.height,box.w*c.width,box.h*c.height);}
  return c.toDataURL("image/png").split(",")[1];
}

async function detectFace(b64){
  const fd=new FormData();fd.append("image_b64",b64);
  const r=await fetch(API+"/api/detect-face",{method:"POST",body:fd});
  const j=await r.json();return j.face?.box||null;
}

sel('#drop').onclick=()=>sel('#file').click();
sel('#file').onchange=e=>{
  file=e.target.files[0];
  sel('#gen').disabled=!role;
  const url=URL.createObjectURL(file);
  imgEl=new Image();imgEl.src=url;
};

document.querySelectorAll('.role').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.role').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');role=b.dataset.role;
  sel('#gen').disabled=!file;
});

sel('#gen').onclick=async()=>{
  sel('#error').textContent="";sel('#gen').disabled=true;
  try{
    const fr=new FileReader();
    const b64=await new Promise(res=>{fr.onload=()=>res(fr.result.split(",")[1]);fr.readAsDataURL(file);});
    faceBox=await detectFace(b64);
    const maskB64=faceBox?makeMask(imgEl,faceBox):"";
    const fd=new FormData();
    fd.append("role",role);fd.append("image_b64",b64);
    if(maskB64) fd.append("mask_b64",maskB64);
    const r=await fetch(API+"/api/generate",{method:"POST",body:fd});
    const j=await r.json();
    if(!j.imageBase64) throw new Error(j.error||"Ошибка");
    const base="data:image/png;base64,"+j.imageBase64;
    sel('#out').src=base;
  }catch(e){sel('#error').textContent=e.message;}
  sel('#gen').disabled=false;
};
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <meta name="description" content="–ú–∏–Ω–∏-—Å–∞–π—Ç: –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç / –ë–ª–æ–≥–µ—Ä / –§–æ—Ç–æ–≥—Ä–∞—Ñ" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    html, body {
      margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial;
      min-height:100%;
    }
    body { display:flex; flex-direction:column; }
    .container { max-width:1040px; margin:0 auto; padding:24px 20px 48px; width:100%; }

    header { display:flex; align-items:center; justify-content:center; position:relative; padding:8px 0 24px; }
    header img { width:80px; height:auto; margin-right:12px; }
    .title { font-size:clamp(28px,4vw,48px); font-weight:800; letter-spacing:-0.02em; margin:0; text-align:center; color:#1e3a8a; }

    .uploader {
      border:2px dashed var(--border); background:#f9fafb; border-radius:24px; padding:40px 24px;
      text-align:center; transition:.2s ease;
    }
    .uploader:hover { border-color:#93c5fd; background:#f0f9ff; }
    .uploader .logo { width:64px; height:64px; object-fit:contain; opacity:.9; margin:0 auto 12px; display:block; }
    .headline { font-size:clamp(18px,2.4vw,22px); font-weight:600; }
    .sub { font-size:14px; color:var(--muted); margin-top:6px; }
    .picked { margin-top:10px; font-size:14px; color:#111827; display:none; }
    .picked strong { font-weight:800; }
    .icon { width:16px; height:16px; vertical-align:-3px; margin-right:6px; }

    .roles { margin-top:22px; }
    .roles-title { text-align:center; font-weight:800; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
    @media (min-width:820px){ .roles-grid{ grid-template-columns:repeat(3,1fr);} }
    .role { border:1px solid var(--border); border-radius:16px; padding:18px; background:white; cursor:pointer; transition:.15s; }
    .role:hover { box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .role.active { border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.2); }

    .actions { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .btn { border:0; border-radius:14px; padding:12px 18px; background:var(--brand); color:#fff; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .link { border:1px solid var(--border); border-radius:14px; padding:10px 16px; text-decoration:none; color:inherit; }

    .loading { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .result { margin-top:18px; text-align:center; }
    .result img { width:100%; max-width:860px; border-radius:18px; border:1px solid var(--border); }

    footer { margin-top:auto; text-align:center; color:#111827; font-size:14px; padding:24px 0; border-top:1px solid #e5e7eb; background:#ffffff; }
    footer .sub { font-size:13px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="./logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
      <h1 class="title">–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1>
    </header>

    <div class="uploader" id="dropzone">
      <img class="logo" src="./logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
      <div class="headline">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
      <div class="sub">JPG, PNG, WEBP</div>
      <div class="picked" id="pickedName"></div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <section class="roles">
      <div class="roles-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è üëâ</div>
      <div class="roles-grid">
        <button class="role" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</button>
        <button class="role" data-role="–±–ª–æ–≥–µ—Ä">–ë–ª–æ–≥–µ—Ä</button>
        <button class="role" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ">–§–æ—Ç–æ–≥—Ä–∞—Ñ</button>
      </div>
    </section>

    <div class="actions">
      <button id="genBtn" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
      <div id="loading" class="loading" style="display:none">
        <span class="spinner"></span><span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</span>
      </div>
      <a id="downloadLink" class="link" download="image.png" style="display:none">–°–∫–∞—á–∞—Ç—å PNG</a>
      <div id="err" style="font-size:14px;color:#dc2626;display:none"></div>
    </div>

    <div class="result" id="resultBox" style="display:none">
      <div style="font-size:13px;color:#6b7280;margin-bottom:6px">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
    </div>
  </div>

  <footer>
    <div>—Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</div>
    <div class="sub">¬© 2025 —Å –ª—é–±–æ–≤—å—é –ö–ú‚Ñ¢</div>
  </footer>

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
let pickedFile = null, pickedRole = null;

const fileInput = document.getElementById("fileInput");
const dropzone = document.getElementById("dropzone");
const genBtn = document.getElementById("genBtn");
const resultImg = document.getElementById("resultImg");
const resultBox = document.getElementById("resultBox");
const downloadLink = document.getElementById("downloadLink");
const errBox = document.getElementById("err");
const loading = document.getElementById("loading");
const pickedName = document.getElementById("pickedName");

dropzone.onclick = () => fileInput.click();
fileInput.onchange = e => onPick(e.target.files[0]);

function onPick(file) {
  if (!file) return;
  pickedFile = file;
  pickedName.style.display = "block";
  pickedName.innerHTML = `<strong>–í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏:</strong> ${file.name}`;
  genBtn.disabled = !pickedRole;
}

document.querySelectorAll(".role").forEach(btn=>{
  btn.onclick = ()=>{
    if (!pickedFile) return;
    document.querySelectorAll(".role").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    pickedRole = btn.dataset.role;
    genBtn.disabled = false;
  };
});

async function fileToB64(f) {
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(",")[1]);
    r.onerror=rej;
    r.readAsDataURL(f);
  });
}

function showErr(msg){ errBox.style.display="block"; errBox.textContent=msg; loading.style.display="none"; }

genBtn.onclick = async ()=>{
  if (!pickedFile || !pickedRole) return;
  errBox.style.display="none"; resultBox.style.display="none"; downloadLink.style.display="none";
  loading.style.display="flex"; genBtn.disabled=true;

  try {
    const srcB64 = await fileToB64(pickedFile);
    const fdFace = new FormData(); fdFace.append("image_b64", srcB64);
    const face = await fetch(API_BASE+"/api/detect-face",{method:"POST",body:fdFace});
    const jFace = await face.json();
    const box = jFace?.face?.box || null;

    const fdG = new FormData(); fdG.append("image_b64", srcB64);
    const gResp = await fetch(API_BASE+"/api/gender",{method:"POST",body:fdG});
    const jGender = await gResp.json();
    const gender = jGender?.gender || "neutral";

    const maskB64 = box ? buildMask(box,512,512) : "";
    const fd = new FormData();
    fd.append("image_b64", srcB64);
    fd.append("mask_b64", maskB64);
    fd.append("role", pickedRole);
    fd.append("gender", gender);
    fd.append("want_w", 384);
    fd.append("want_h", 384);

    const r = await fetch(API_BASE+"/api/generate",{method:"POST",body:fd});
    const j = await r.json();
    if (!r.ok || !j.imageBase64) throw new Error(j.error||"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
    resultImg.src = "data:image/png;base64," + j.imageBase64;
    resultBox.style.display="block";
    downloadLink.href = resultImg.src;
    downloadLink.style.display="inline-block";
  } catch(e){
    showErr(e.message);
  } finally {
    loading.style.display="none";
    genBtn.disabled=false;
  }
};

function buildMask(box,W,H){
  const c=document.createElement("canvas"); c.width=W; c.height=H;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  const cx = (box.x + box.w/2)*W, cy=(box.y+box.h/2)*H;
  const rw=box.w*W*0.6, rh=box.h*H*0.7;
  ctx.fillStyle="#000";
  ctx.beginPath(); ctx.ellipse(cx,cy,rw,rh,0,0,2*Math.PI); ctx.fill();
  return c.toDataURL("image/png").split(",")[1];
}
</script>
</body>
</html>

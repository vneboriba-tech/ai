<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>MediaGen Worker</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2em; }
    #result { margin-top: 20px; display:none; }
    img { max-width: 400px; border-radius: 10px; display:block; margin:10px 0; }
    textarea { width:100%; height:120px; }
  </style>
</head>
<body>
  <h2>üé® Media Generator</h2>

  <input type="file" id="file" accept="image/*"><br><br>
  <select id="role">
    <option>–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</option>
    <option>–ë–ª–æ–≥–µ—Ä</option>
    <option>–§–æ—Ç–æ–≥—Ä–∞—Ñ</option>
  </select>
  <button id="generate">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑</button>
  <div id="status"></div>

  <div id="result">
    <img id="resultImg">
    <a id="downloadLink" download="result.png">–°–∫–∞—á–∞—Ç—å</a>
  </div>

<script>
const API = "https://media-gen-worker.vneboriba.workers.dev";
const LOGO_URL = "./logo.png";

function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>rej();i.src=src;});}

async function composeLogo(base64){
  try {
    const img=await loadImage("data:image/png;base64,"+base64);
    const W=img.width,H=img.height;
    const c=document.createElement("canvas");c.width=W;c.height=H;
    const ctx=c.getContext("2d");
    ctx.drawImage(img,0,0,W,H);
    const logo=await loadImage(LOGO_URL);
    const w=Math.round(W*0.14),h=w*(logo.height/logo.width);
    const pad=Math.round(w*0.08);
    const x=W-w-pad,y=H-h-pad;
    ctx.globalAlpha=0.95;ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.fillRect(x-pad,y-pad,w+pad*2,h+pad*2);
    ctx.globalAlpha=1;
    ctx.drawImage(logo,x,y,w,h);
    return c.toDataURL("image/png");
  }catch{return "data:image/png;base64,"+base64;}
}

document.getElementById("generate").onclick=async()=>{
  const file=document.getElementById("file").files[0];
  const role=document.getElementById("role").value;
  if(!file){alert("–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ");return;}
  const fd=new FormData();
  fd.append("role",role);
  fd.append("image",file);
  document.getElementById("status").textContent="‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";
  document.getElementById("result").style.display="none";
  try{
    const resp=await fetch(API+"/api/generate",{method:"POST",body:fd});
    const raw=await resp.text();
    if(!resp.ok){
      const j=(()=>{try{return JSON.parse(raw)}catch{return null}})();
      const msg=j?.error||raw||("HTTP "+resp.status);
      const det=j?.details?("\n\ndetails:\n"+JSON.stringify(j.details,null,2)):"";
      throw new Error(msg+det);
    }
    const data=(()=>{try{return JSON.parse(raw)}catch{return null}})();
    if(!data?.imageBase64) throw new Error("–ù–µ—Ç imageBase64");
    const final=await composeLogo(data.imageBase64);
    document.getElementById("resultImg").src=final;
    document.getElementById("downloadLink").href=final;
    document.getElementById("result").style.display="block";
    document.getElementById("status").textContent="‚úÖ –ì–æ—Ç–æ–≤–æ!";
  }catch(e){
    document.getElementById("status").textContent="‚ùå –û—à–∏–±–∫–∞: "+e.message;
    console.error(e);
  }
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #fff;
      color: #1a1a1a;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      font-weight: 800;
      margin: 30px 0 10px;
    }
    h2 {
      font-size: 1.2em;
      font-weight: 600;
      margin-top: 20px;
    }
    .upload-box {
      border: 2px dashed #ccc;
      border-radius: 16px;
      padding: 20px;
      margin: 20px auto;
      max-width: 320px;
      background: #fafafa;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    .role-btn {
      display: block;
      margin: 8px auto;
      padding: 14px;
      width: 280px;
      border-radius: 12px;
      border: 2px solid #ccc;
      background: #fff;
      font-size: 1em;
      font-weight: 600;
      color: #0057ff;
      cursor: pointer;
      transition: 0.2s;
    }
    .role-btn.active {
      border-color: #0057ff;
      background: #eaf1ff;
    }
    .gen-btn {
      margin: 20px auto;
      display: block;
      width: 280px;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: #0057ff;
      color: white;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
    }
    .result-box {
      margin: 20px auto;
      max-width: 340px;
      padding: 10px;
      border-radius: 16px;
      background: #fafafa;
    }
    #resultImage {
      width: 100%;
      border-radius: 12px;
    }
    .footer {
      font-size: 0.9em;
      color: #555;
      margin: 40px 0 20px;
    }
    .small {
      font-size: 0.8em;
      color: #777;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è<br>–∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1>

  <div class="upload-box">
    <img src="–ü–æ—á—É–≤—Å—Ç–≤—É–π%20—Å–µ–±—è%20–∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º.png" alt="–§–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏" width="80"><br>
    <p><strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</strong><br>JPG, PNG, WEBP</p>
    <input type="file" id="imageInput" accept="image/*">
    <p id="uploadStatus" class="small"></p>
  </div>

  <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è üëâ</h2>
  <button class="role-btn" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</button>
  <button class="role-btn" data-role="–±–ª–æ–≥–µ—Ä">–ë–ª–æ–≥–µ—Ä</button>
  <button class="role-btn" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ">–§–æ—Ç–æ–≥—Ä–∞—Ñ</button>

  <button class="gen-btn" id="generateBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
  <button class="gen-btn" id="downloadBtn" style="background:#777; display:none;">–°–∫–∞—á–∞—Ç—å PNG</button>

  <div id="status" class="small"></div>
  <div class="result-box" id="resultBox" style="display:none;">
    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
    <img id="resultImage" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç">
  </div>

  <div class="footer">
    —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£<br>
    <span class="small">¬© 2025 —Å –ª—é–±–æ–≤—å—é KM‚Ñ¢</span>
  </div>

  <script>
    const workerURL = "https://media-gen-worker.vneboriba.workers.dev";
    let imageB64 = "";
    let selectedRole = "";
    let detectedGender = "unknown";
    let detectFace = false;

    const imageInput = document.getElementById("imageInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const generateBtn = document.getElementById("generateBtn");
    const status = document.getElementById("status");
    const resultBox = document.getElementById("resultBox");
    const resultImage = document.getElementById("resultImage");
    const downloadBtn = document.getElementById("downloadBtn");

    document.querySelectorAll(".role-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".role-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedRole = btn.dataset.role;
      });
    });

    imageInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadStatus.textContent = "‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º...";
      const reader = new FileReader();
      reader.onload = async () => {
        imageB64 = reader.result.split(",")[1];
        uploadStatus.textContent = `‚úÖ –í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏: ${file.name} (${(file.size/1024/1024).toFixed(1)} –ú–ë)`;
        await detectGenderAndFace(imageB64);
      };
      reader.readAsDataURL(file);
    });

    async function detectGenderAndFace(b64) {
      try {
        const fd = new FormData();
        fd.append("image_b64", b64);
        const res = await fetch(`${workerURL}/api/gender`, { method: "POST", body: fd });
        const data = await res.json();
        detectedGender = data.gender || "unknown";
        status.textContent = `detect-face: `;
        const fd2 = new FormData();
        fd2.append("image_b64", b64);
        const res2 = await fetch(`${workerURL}/api/detect-face`, { method: "POST", body: fd2 });
        const data2 = await res2.json();
        detectFace = !!(data2 && data2.ok);
        status.textContent += detectFace ? "–¥–∞" : "–Ω–µ—Ç";
      } catch (e) {
        status.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–æ—Ç–æ.";
      }
    }

    generateBtn.addEventListener("click", async () => {
      if (!imageB64) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ");
      if (!selectedRole) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è");

      generateBtn.disabled = true;
      generateBtn.textContent = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";
      status.textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...";
      resultBox.style.display = "none";
      downloadBtn.style.display = "none";

      try {
        const fd = new FormData();
        fd.append("image_b64", imageB64);
        fd.append("role", selectedRole);
        fd.append("gender", detectedGender);

        const res = await fetch(`${workerURL}/api/generate`, { method: "POST", body: fd });
        const data = await res.json();

        if (data.imageBase64) {
          resultBox.style.display = "block";
          resultImage.src = `data:image/png;base64,${data.imageBase64}`;
          downloadBtn.style.display = "block";
          downloadBtn.onclick = () => {
            const a = document.createElement("a");
            a.href = resultImage.src;
            a.download = "mediastart_result.png";
            a.click();
          };
          status.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
        } else {
          status.textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å. " + (data.error || "–û—à–∏–±–∫–∞");
        }
      } catch (e) {
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞";
      }

      generateBtn.disabled = false;
      generateBtn.textContent = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑";
    });
  </script>
</body>
</html>

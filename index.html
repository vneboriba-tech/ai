<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
<meta name="description" content="–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç / –ë–ª–æ–≥–µ—Ä / –§–æ—Ç–æ–≥—Ä–∞—Ñ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–∏—Ü–∞" />
<style>
  :root { --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --brand:#2563eb; --border:#e5e7eb; }
  *{ box-sizing:border-box }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg);
    font-family:-apple-system, BlinkMacSystemFont, "Avenir Next", Segoe UI, Roboto, Helvetica, Arial; }
  .container{ max-width:980px; margin:0 auto; padding:24px 20px 64px; }
  header{ text-align:center; margin-bottom:20px }
  .title{ font-size:clamp(28px,4vw,44px); font-weight:800; letter-spacing:-.02em; margin:0 }
  .uploader{ border:2px dashed var(--border); border-radius:24px; padding:34px 20px; background:#f8fafc; text-align:center }
  .uploader:hover{ border-color:#93c5fd; background:#f0f9ff }
  .uploader .logo{ width:66px; height:66px; object-fit:contain; opacity:.96; display:block; margin:0 auto 10px }
  .headline{ font-size:18px; font-weight:800 }
  .sub{ font-size:14px; color:var(--muted) }
  .picked{ margin-top:8px; font-size:14px }
  .roles-title{ text-align:center; font-weight:900; margin:22px 0 10px }
  .roles-grid{ display:grid; grid-template-columns:1fr; gap:12px }
  @media(min-width:760px){ .roles-grid{ grid-template-columns:repeat(3,1fr) } }
  .role{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; cursor:pointer;
         font-size:18px; font-weight:800; transition:.15s }
  .role.active{ border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.25) }
  .actions{ margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px }
  .btn{ border:0; border-radius:14px; padding:14px 20px; background:var(--brand); color:#fff; font-weight:900; font-size:18px; cursor:pointer }
  .btn:disabled{ opacity:.55; cursor:not-allowed }
  .link{ border:1px solid var(--border); border-radius:14px; padding:12px 16px; font-weight:800; text-decoration:none; color:inherit }
  .loading{ display:none; align-items:center; gap:8px; font-size:14px; color:#334155 }
  .spinner{ width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:var(--brand); border-radius:50%; animation:spin 1s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .result{ margin-top:20px; text-align:center }
  .result img{ width:100%; max-width:840px; border-radius:18px; border:1px solid var(--border) }
  footer{ margin-top:40px; text-align:center; color:#64748b; font-size:14px }
  .err{ color:#dc2626; font-size:14px; display:none; text-align:center }
</style>
</head>
<body>
<div class="container">
  <header><h1 class="title">–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1></header>

  <div class="uploader" id="dropzone">
    <img class="logo" src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
    <div class="headline">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
    <div class="sub">JPG / PNG / WEBP (–¥–æ 12 –ú–ë)</div>
    <input id="fileInput" type="file" accept="image/*" style="display:none" />
    <div id="picked" class="picked"></div>
  </div>

  <div class="roles">
    <div class="roles-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è üëâ</div>
    <div class="roles-grid">
      <button class="role" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</button>
      <button class="role" data-role="–±–ª–æ–≥–µ—Ä">–ë–ª–æ–≥–µ—Ä</button>
      <button class="role" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ">–§–æ—Ç–æ–≥—Ä–∞—Ñ</button>
    </div>
  </div>

  <div class="actions">
    <button id="genBtn" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
    <div id="loading" class="loading"><span class="spinner"></span><span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</span></div>
    <a id="download" class="link" download="image.png" style="display:none">–°–∫–∞—á–∞—Ç—å PNG</a>
    <div id="error" class="err"></div>
  </div>

  <div class="result" id="resultBox" style="display:none">
    <div style="font-size:13px;color:#64748b;margin-bottom:6px">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
    <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
  </div>
</div>

<footer>¬© 2025 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</footer>

<!-- –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞, —á—Ç–æ–±—ã Canvas —Ä–∏—Å–æ–≤–∞–ª –±–µ–∑ CORS-–∫–∞–ø—Ä–∏–∑–æ–≤ -->
<img id="logoPreload" src="logo.png?v=1" alt="" style="display:none" crossorigin="anonymous" />

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
const LOGO_URL = "logo.png?v=1"; // cache-buster

let file=null, role=null;
const input = document.getElementById("fileInput");
const drop  = document.getElementById("dropzone");
const picked= document.getElementById("picked");
const btn   = document.getElementById("genBtn");
const loading=document.getElementById("loading");
const resultBox=document.getElementById("resultBox");
const resultImg=document.getElementById("resultImg");
const download = document.getElementById("download");
const errBox   = document.getElementById("error");

drop.addEventListener("click", ()=>input.click());
drop.addEventListener("dragover", e=>e.preventDefault());
drop.addEventListener("drop", e=>{ e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) onFile(f); });
input.addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) onFile(f); });

function onFile(f){
  if(!f) return;
  if(!(f.type||"").startsWith("image/")) return showErr("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
  if (f.size > 12*1024*1024) return showErr("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–¥–æ 12 –ú–ë).");
  file=f; picked.textContent=`–í—ã –≤—ã–±—Ä–∞–ª–∏: ${f.name}`; hideErr(); btn.disabled = !role;
}
document.querySelectorAll(".role").forEach(b=>b.addEventListener("click", ()=>{
  document.querySelectorAll(".role").forEach(x=>x.classList.remove("active"));
  b.classList.add("active"); role=b.dataset.role; btn.disabled = !file;
}));

function showErr(m){ errBox.style.display='block'; errBox.textContent=m; }
function hideErr(){ errBox.style.display='none'; }
function showLoading(v){ loading.style.display = v ? "flex":"none"; }

function fileToB64(f){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(String(r.result).split(",")[1]||"");
    r.onerror=()=>rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª"));
    r.readAsDataURL(f);
  });
}
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const i=new Image(); i.crossOrigin="anonymous";
    i.onload=()=>resolve(i); i.onerror=()=>reject(new Error("Load failed"));
    i.src = src.includes("?") ? src : (src + "?v=" + Date.now());
  });
}
async function addLogo(b64){
  try{
    const base=await loadImage("data:image/png;base64,"+b64);
    let logo=document.getElementById("logoPreload");
    if (!logo || logo.naturalWidth===0) logo = await loadImage(LOGO_URL);

    const W=base.naturalWidth||base.width, H=base.naturalHeight||base.height;
    const c=document.createElement("canvas"); c.width=W; c.height=H;
    const ctx=c.getContext("2d");
    ctx.drawImage(base,0,0,W,H);

    const margin=Math.round(Math.min(W,H)*0.02);
    const w=Math.round(W*0.16);
    const ratio=(logo.naturalWidth||logo.width)/(logo.naturalHeight||logo.height);
    const h=Math.round(w/ratio);
    const x=W-w-margin, y=H-h-margin;

    const pad=Math.round(w*0.10);
    const r=Math.round(Math.min(w+pad*2,h+pad*2)*0.18);
    ctx.save(); roundRect(ctx, x-pad, y-pad, w+pad*2, h+pad*2, r);
    ctx.fillStyle="rgba(255,255,255,.95)"; ctx.fill(); ctx.restore();

    ctx.drawImage(logo,x,y,w,h);
    return c.toDataURL("image/png");
  }catch(e){ console.warn("Logo overlay:", e.message); return "data:image/png;base64,"+b64; }
}
function roundRect(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

btn.addEventListener("click", async ()=>{
  hideErr(); showLoading(true); btn.disabled=true;
  resultBox.style.display="none"; resultImg.removeAttribute("src"); download.style.display="none";
  try{
    if (!file || !role) throw new Error("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.");
    const b64 = await fileToB64(file);

    const fd = new FormData();
    fd.append("role", role);
    fd.append("image_b64", b64);

    const resp = await fetch(API_BASE+"/api/generate", { method:"POST", body:fd });
    const raw  = await resp.text();
    if (!resp.ok){
      try{ const j=JSON.parse(raw); throw new Error(j.error || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"); }
      catch{ throw new Error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"); }
    }
    const data = JSON.parse(raw);
    if (!data?.imageBase64) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç API");

    const finalUrl = await addLogo(data.imageBase64);
    resultImg.src = finalUrl;
    resultBox.style.display="block";
    download.href = finalUrl;
    download.style.display="inline-block";
  }catch(e){ showErr(e.message); }
  finally{ showLoading(false); btn.disabled=false; }
});
</script>
</body>
</html>

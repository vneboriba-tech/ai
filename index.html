<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Почувствуй себя журналистом</title>

  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial; }
    body { display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { text-align:center; margin-top:24px; margin-bottom:16px; }
    h1 { font-size:clamp(28px,4vw,42px); margin:0; font-weight:800; }

    .container { width:100%; max-width:960px; padding:20px; }

    .uploader { position:relative; border:2px dashed var(--border);
      border-radius:24px; padding:40px 20px; background:#f9fafb; text-align:center;
      cursor:pointer; transition:.2s; }
    .uploader:hover { border-color:var(--accent); background:#f0f9ff; }
    .uploader img.logo { width:72px; height:72px; margin-bottom:12px; pointer-events:none; }
    .uploader input[type=file]{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    .headline { font-weight:700; font-size:18px; pointer-events:none; }
    .sub { color:var(--muted); font-size:14px; margin-top:6px; pointer-events:none; }

    .picked { margin-top:10px; font-size:14px; }

    .roles { margin-top:24px; }
    .roles-title { text-align:center; font-weight:700; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns:repeat(3,1fr);
      gap:12px; margin-top:12px; }
    .role { border:1px solid var(--border); border-radius:14px; padding:12px;
      font-weight:700; cursor:pointer; background:#fff; transition:.15s; }
    .role.active { border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.2); }

    .status { margin-top:20px; text-align:center; font-size:15px; white-space:pre-wrap; }
    .err { color:#dc2626; font-size:14px; text-align:center; margin-top:10px; display:none; white-space:pre-wrap; }

    .result { margin-top:24px; text-align:center; }
    .result img { width:100%; max-width:800px; border-radius:18px; border:1px solid var(--border); }

    .btn { background:#10b981; color:#fff; padding:10px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:700; }
    .btn:hover { background:#059669; }
  </style>
</head>

<body>
<div class="container">
  <header><h1>Почувствуй себя журналистом</h1></header>

  <div class="uploader">
    <img src="logo.png" class="logo" alt="">
    <div class="headline">Загрузите фото</div>
    <div class="sub">JPG, PNG, WEBP, GIF до 12 МБ</div>
    <input id="fileInput" type="file" accept="image/*">
    <div id="picked" class="picked"></div>
  </div>

  <div class="roles">
    <div class="roles-title">Выберите роль</div>
    <div class="roles-grid">
      <button class="role active" data-role="журналист">Журналист</button>
      <button class="role" data-role="блогер">Блогер</button>
      <button class="role" data-role="фотограф">Фотограф</button>
    </div>
  </div>

  <div id="status" class="status">Готово к работе</div>
  <div id="error" class="err"></div>

  <div id="resultBox" class="result" style="display:none;">
    <img id="resultImg" alt="Результат">
    <div style="margin-top:12px;">
      <a id="download" class="btn" download="result.png">Скачать PNG</a>
    </div>
  </div>
</div>

<script>
/* ================= НАСТРОЙКИ ================= */
const API_BASE = "https://media-gen-worker2.vneboriba.workers.dev";
const CANVAS_W = 720;
const CANVAS_H = 1024;
const MAX_MB = 12;

const DEFAULT_STEPS = 20;
const DEFAULT_GUIDANCE = 7.0;
const DEFAULT_STRENGTH = 0.55;

/* ================= STATE ================= */
let file = null;
let role = "журналист";

/* ================= UI ================= */
const input = document.getElementById("fileInput");
const picked = document.getElementById("picked");
const statusEl = document.getElementById("status");
const errEl = document.getElementById("error");
const resultBox = document.getElementById("resultBox");
const resultImg = document.getElementById("resultImg");
const download = document.getElementById("download");

/* ================= HELPERS ================= */
function showErr(msg){
  errEl.innerText = msg;
  errEl.style.display = "block";
  statusEl.innerText = "Ошибка";
}
function hideErr(){
  errEl.style.display = "none";
  errEl.innerText = "";
}

document.querySelectorAll(".role").forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll(".role").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    role = btn.dataset.role;
    if (file) generate();
  };
});

function readAsDataURL(f){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(f);
  });
}

async function resizeFile(f){
  const dataURL = await readAsDataURL(f);
  const img = await new Promise((res,rej)=>{
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = dataURL;
  });

  const c = document.createElement("canvas");
  c.width = CANVAS_W;
  c.height = CANVAS_H;
  const g = c.getContext("2d");

  const scale = Math.max(CANVAS_W/img.width, CANVAS_H/img.height);
  const dw = img.width*scale;
  const dh = img.height*scale;
  const dx = (CANVAS_W-dw)/2;
  const dy = (CANVAS_H-dh)/2;

  g.drawImage(img, dx, dy, dw, dh);

  const out = c.toDataURL("image/jpeg", 0.9);
  return out.split(",")[1];
}

/* ================= EVENTS ================= */
input.onchange = e => {
  const f = e.target.files[0];
  if (!f) return;

  if (!f.type.startsWith("image/")) return showErr("Нужен файл изображения");
  if (f.size > MAX_MB*1024*1024) return showErr("Файл слишком большой");

  file = f;
  picked.innerText = "Вы выбрали: " + f.name;
  hideErr();
  generate();
};

async function generate(){
  resultBox.style.display = "none";
  hideErr();
  statusEl.innerText = "Подготовка фото…";

  try {
    const imgB64 = await resizeFile(file);
    statusEl.innerText = "Генерация…";

    const fd = new FormData();
    fd.append("image_b64", imgB64);
    fd.append("width", CANVAS_W);
    fd.append("height", CANVAS_H);
    fd.append("num_steps", DEFAULT_STEPS);
    fd.append("guidance", DEFAULT_GUIDANCE);
    fd.append("strength", DEFAULT_STRENGTH);
    fd.append("prompt", "photorealistic portrait");

    const resp = await fetch(API_BASE + "/api/img2img-raw", {
      method: "POST",
      body: fd
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(txt || "AI error");
    }

    const blob = await resp.blob();
    const pngB64 = await new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result.split(",")[1]);
      r.onerror = rej;
      r.readAsDataURL(blob);
    });

    const finalUrl = "data:image/png;base64," + pngB64;

    resultImg.src = finalUrl;
    download.href = finalUrl;
    resultBox.style.display = "block";
    statusEl.innerText = "Готово!";
  } catch(e){
    showErr("Ошибка: " + e.message);
  }
}
</script>
</body>
</html>

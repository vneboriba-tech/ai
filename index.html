<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</title>
  <meta name="description" content="–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç / –ë–ª–æ–≥–µ—Ä / –§–æ—Ç–æ–≥—Ä–∞—Ñ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–∏—Ü–∞" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial; min-height:100%; }
    body { display:flex; flex-direction:column; align-items:center; }
    .container { width:100%; max-width:960px; padding:24px; }
    header { text-align:center; margin-bottom:24px; }
    .title { font-size:clamp(28px,4vw,44px); font-weight:800; letter-spacing:-0.02em; margin:0; }

    .uploader { border:2px dashed var(--border); border-radius:24px; padding:40px 20px; text-align:center; transition:.2s; background:#f9fafb; }
    .uploader:hover { border-color:#3b82f6; background:#f0f9ff; }
    .uploader .logo { width:64px; height:64px; object-fit:contain; opacity:.95; display:block; margin:0 auto 12px; }
    .uploader .headline { font-size:18px; font-weight:700; }
    .uploader .sub { font-size:14px; color:var(--muted); margin-top:6px; }
    .picked { font-size:14px; margin-top:10px; color:#111827; }

    .roles-title { text-align:center; font-weight:800; margin-top:24px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:720px){ .roles-grid{grid-template-columns:repeat(3,1fr);} }
    .role { border:1px solid var(--border); border-radius:16px; padding:16px; cursor:pointer;
      background:#fff; transition:.15s; font-size:16px; font-weight:800; }
    .role:hover { box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .role.active { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.25); }

    .actions { margin-top:20px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .btn { border:0; border-radius:14px; padding:12px 20px; background:var(--brand); color:#fff; font-weight:800; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .loading { display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; }
    .spinner { width:16px; height:16px; border:2px solid #cbd5e1; border-top-color:var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .result { margin-top:24px; text-align:center; }
    .result img { width:100%; max-width:800px; border-radius:18px; border:1px solid var(--border); }

    .err { color:#dc2626; font-size:14px; white-space:pre-wrap; display:none; }
    footer { margin-top:40px; text-align:center; color:#6b7280; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1 class="title">–ü–æ—á—É–≤—Å—Ç–≤—É–π —Å–µ–±—è –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º</h1></header>

    <div class="uploader" id="dropzone">
      <img class="logo" src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
      <div class="headline">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</div>
      <div class="sub">JPG, PNG, WEBP (–¥–æ 12 –ú–ë)</div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <div id="picked" class="picked"></div>
    </div>

    <div class="roles">
      <div class="roles-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</div>
      <div class="roles-grid">
        <button class="role" data-role="–∂—É—Ä–Ω–∞–ª–∏—Å—Ç">–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç</button>
        <button class="role" data-role="–±–ª–æ–≥–µ—Ä">–ë–ª–æ–≥–µ—Ä</button>
        <button class="role" data-role="—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ">–§–æ—Ç–æ–≥—Ä–∞—Ñ</button>
      </div>
    </div>

    <div class="actions">
      <button id="genBtn" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑</button>
      <div id="loading" class="loading" style="display:none"><span class="spinner"></span><span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶</span></div>
      <a id="download" class="btn" download="result.png" style="display:none;background:#10b981;">–°–∫–∞—á–∞—Ç—å PNG</a>
      <div id="error" class="err"></div>
    </div>

    <div class="result" id="resultBox" style="display:none;">
      <img id="resultImg" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
    </div>
  </div>

  <footer>¬© 2025 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏ –ú–ì–£</footer>

  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ -->
  <img id="logoPreload" src="logo.png?v=1" alt="" style="display:none" crossorigin="anonymous" />

  <!-- üì¶ Mediapipe: FaceMesh (468 –ª–µ–Ω–¥–º–∞—Ä–æ–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
const LOGO_URL = "logo.png?v=1";

/* ===== STATE / DOM ===== */
let file = null, role = null;
const input = document.getElementById('fileInput');
const drop = document.getElementById('dropzone');
const picked = document.getElementById('picked');
const btn = document.getElementById('genBtn');
const loading = document.getElementById('loading');
const resultBox = document.getElementById('resultBox');
const resultImg = document.getElementById('resultImg');
const download = document.getElementById('download');
const err = document.getElementById('error');

/* ===== Validations ===== */
(function apiGuard(){
  const base = (API_BASE || "").trim();
  if (!(base === "" || /^https?:\/\//i.test(base))) {
    throw new Error("API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ: –∑–∞–¥–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π https:// URL –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ UI –∏–∑ —Ç–æ–≥–æ –∂–µ –≤–æ—Ä–∫–µ—Ä–∞.");
  }
})();

/* ===== Uploader ===== */
drop.addEventListener('click', ()=>input.click());
drop.addEventListener('dragover', e => e.preventDefault());
drop.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files?.[0]; if (f) onFile(f); });
input.addEventListener('change', e => onFile(e.target.files?.[0]));
function onFile(f){
  if (!f) return;
  if (!(f.type||"").startsWith('image/')) return showErr("–ù—É–∂–µ–Ω —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
  if (f.size > 12*1024*1024) return showErr("–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (–¥–æ 12 –ú–ë).");
  file = f;
  picked.textContent = `–í—ã –≤—ã–±—Ä–∞–ª–∏: ${f.name}`;
  btn.disabled = !role;
  hideErr();
}
document.querySelectorAll('.role').forEach(b => b.addEventListener('click', () => {
  document.querySelectorAll('.role').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  role = b.dataset.role;
  btn.disabled = !file;
}));

/* ===== Helpers ===== */
function normalizeError(e){ if (!e) return "Unknown error"; if (e instanceof Error && e.message) return e.message; if (typeof e === "string") return e; try{ return JSON.stringify(e);}catch{return String(e);} }
function showErr(m){ err.style.display='block'; err.innerText = normalizeError(m); }
function hideErr(){ err.style.display='none'; err.innerText=""; }
function showLoading(s){ loading.style.display = s ? 'flex' : 'none'; }

function fileToB64(f){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(String(r.result).split(',')[1]||'');
    r.onerror=()=>rej(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª"));
    r.readAsDataURL(f);
  });
}
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const img=new Image(); img.crossOrigin="anonymous";
    img.onload=()=>resolve(img);
    img.onerror=()=>reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: "+(src?.slice?.(0,80)||src)));
    img.src = src.includes("?") ? src : (src + "?v=" + Date.now());
  });
}
function roundRect(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
async function addLogoToBase64(b64OrDataUrl){
  try{
    const isDataUrl = /^data:image\//i.test(b64OrDataUrl);
    const base = await loadImage(isDataUrl ? b64OrDataUrl : ("data:image/png;base64,"+b64OrDataUrl));
    const logoEl=document.getElementById('logoPreload');
    const logo=(logoEl && logoEl.naturalWidth>0)?logoEl:await loadImage(LOGO_URL);
    const W=base.naturalWidth||base.width, H=base.naturalHeight||base.height;
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const ctx=c.getContext('2d'); ctx.drawImage(base,0,0,W,H);
    const margin=Math.round(Math.min(W,H)*0.02);
    const targetW=Math.round(W*0.18);
    const ratio=(logo.naturalWidth||logo.width)/(logo.naturalHeight||logo.height);
    const targetH=Math.round(targetW/ratio);
    const x=W-targetW-margin, y=H-targetH-margin;
    const pad=Math.round(targetW*0.10);
    const bx=x-pad, by=y-pad, bw=targetW+pad*2, bh=targetH+pad*2;
    const rr=Math.round(Math.min(bw,bh)*0.18);
    ctx.save(); roundRect(ctx,bx,by,bw,bh,rr); ctx.fillStyle="rgba(255,255,255,0.94)"; ctx.fill(); ctx.restore();
    ctx.globalAlpha=0.98; ctx.drawImage(logo,x,y,targetW,targetH); ctx.globalAlpha=1;
    return c.toDataURL('image/png');
  }catch(e){ 
    console.error("addLogoToBase64:", e);
    return /^data:image\//i.test(b64OrDataUrl) ? b64OrDataUrl : "data:image/png;base64,"+b64OrDataUrl;
  }
}

/* ======== FACE LOCK v2: FaceMesh (468 —Ç–æ—á–µ–∫) ======== */
let faceMesh = null;
async function ensureFaceMesh(){
  if (faceMesh) return faceMesh;
  return new Promise((resolve)=>{
    const fm = new FaceMesh.FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });
    fm.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.3,
      minTrackingConfidence: 0.3
    });
    fm.onResults(()=>{});
    faceMesh = fm;
    resolve(fm);
  });
}
async function getLandmarks(imgEl){
  await ensureFaceMesh();
  const canvas = document.createElement('canvas');
  canvas.width = imgEl.naturalWidth || imgEl.width;
  canvas.height = imgEl.naturalHeight || imgEl.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(imgEl,0,0,canvas.width,canvas.height);
  return new Promise((resolve)=>{
    faceMesh.onResults((res)=>{
      const f = res.multiFaceLandmarks && res.multiFaceLandmarks[0];
      resolve(f || null);
    });
    faceMesh.send({image: canvas});
  });
}

// –ò–Ω–¥–µ–∫—Å—ã –æ–≤–∞–ª–∞ –ª–∏—Ü–∞ –≤ FaceMesh (–ø—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª–±–∞‚Üí—É—Ö–æ‚Üí–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫‚Üí—É—Ö–æ‚Üí–ª–æ–±)
const OVAL_IDX = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109, 10];

// –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –≥–ª–∞–∑/–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫
const LEFT_EYE_IDX = [33, 133], RIGHT_EYE_IDX = [362, 263], CHIN_IDX = 152;

function avgPoint(pts, idxs){
  const arr = idxs.map(i => pts[i]).filter(Boolean);
  const x = arr.reduce((s,p)=>s+p.x,0)/arr.length;
  const y = arr.reduce((s,p)=>s+p.y,0)/arr.length;
  return {x,y};
}

function buildPolygonMask(w,h, points){ // points –≤ –ø–∏–∫—Å–µ–ª—è—Ö
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.closePath();
  ctx.fill();

  // –º—è–≥–∫–∏–µ –∫—Ä–∞—è
  const feather = Math.max(10, Math.floor(Math.min(w,h)*0.02));
  const blurC = document.createElement('canvas'); blurC.width=w; blurC.height=h;
  const bctx = blurC.getContext('2d');
  bctx.filter = `blur(${feather}px)`;
  bctx.drawImage(c,0,0);
  return blurC;
}

function drawImageWithTransform(ctx, img, sx,sy,sw,sh, dx,dy, scale, rot){
  ctx.save();
  ctx.translate(dx, dy);
  ctx.rotate(rot);
  ctx.scale(scale, scale);
  // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤–æ–∫—Ä—É–≥ —Å–µ—Ä–µ–¥–∏–Ω—ã –ª–∏—Ü–∞
  ctx.drawImage(img, sx,sy,sw,sh, -sw/2, -sh/2, sw, sh);
  ctx.restore();
}

function computeAlignment(srcPts, dstPts, imgW, imgH){
  // –±–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä—ã –≥–ª–∞–∑ –∏ –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫
  const sL = avgPoint(srcPts, LEFT_EYE_IDX), sR = avgPoint(srcPts, RIGHT_EYE_IDX), sC = srcPts[CHIN_IDX];
  const dL = avgPoint(dstPts, LEFT_EYE_IDX), dR = avgPoint(dstPts, RIGHT_EYE_IDX), dC = dstPts[CHIN_IDX];

  // —É–≥–æ–ª ‚Äî –ø–æ –ª–∏–Ω–∏–∏ –≥–ª–∞–∑
  const sAng = Math.atan2((sR.y - sL.y), (sR.x - sL.x));
  const dAng = Math.atan2((dR.y - dL.y), (dR.x - dL.x));
  const rot = dAng - sAng;

  // –º–∞—Å—à—Ç–∞–± ‚Äî –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –º–µ–∂–¥—É –≥–ª–∞–∑–∞–º–∏ (—É—Å—Ä–µ–¥–Ω–∏–º —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º –≥–ª–∞–∑‚Üí–ø–æ–¥–±–æ—Ä–æ–¥–æ–∫)
  const dist = (a,b)=>Math.hypot(a.x-b.x, a.y-b.y);
  const sEye = dist(sL,sR), dEye = dist(dL,dR);
  const sEC  = (dist(sL,sC)+dist(sR,sC))/2;
  const dEC  = (dist(dL,dC)+dist(dR,dC))/2;
  const scale = ((dEye/sEye) + (dEC/sEC)) / 2;

  // —Ü–µ–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ ‚Äî —Å–µ—Ä–µ–¥–∏–Ω–∞ –º–µ–∂–¥—É –≥–ª–∞–∑–∞–º–∏, —Å–º–µ—â—ë–Ω–Ω–∞—è –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É
  const dCenter = { x: (dL.x + dR.x)/2, y: (dL.y + dR.y)/2 };
  const target = { x: dCenter.x*imgW, y: dCenter.y*imgH + 0.12*imgH }; // –Ω–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤–Ω–∏–∑

  return { scale, rot, target };
}

async function faceLockComposite(srcDataUrl, dstDataUrl){
  const toImg = (url)=> new Promise((ok,err)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>ok(i); i.onerror=()=>err(new Error("load fail")); i.src=url; });
  const src = await toImg(/^data:image\//.test(srcDataUrl)?srcDataUrl:`data:image/*;base64,${srcDataUrl}`);
  const dst = await toImg(/^data:image\//.test(dstDataUrl)?dstDataUrl:`data:image/*;base64,${dstDataUrl}`);

  const sLM = await getLandmarks(src);
  const dLM = await getLandmarks(dst);
  if (!sLM || !dLM) return (/^data:image\//.test(dstDataUrl)?dstDataUrl:`data:image/*;base64,${dstDataUrl}`);

  const W = dst.naturalWidth || dst.width, H = dst.naturalHeight || dst.height;
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(dst,0,0,W,H);

  // –ø–æ–ª–∏–≥–æ–Ω –æ–≤–∞–ª–∞ –ª–∏—Ü–∞ –≤ dst (–≤ –ø–∏–∫—Å–µ–ª—è—Ö)
  const dstPoly = OVAL_IDX.map(i => ({ x: dLM[i].x*W, y: dLM[i].y*H }));
  const mask = buildPolygonMask(W,H,dstPoly);

  // –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç ‚Äî bbox –ø–æ –æ–≤–∞–ª—É –≤ src
  const sW = src.naturalWidth || src.width, sH = src.naturalHeight || src.height;
  const srcPoly = OVAL_IDX.map(i => ({ x: sLM[i].x*sW, y: sLM[i].y*sH }));
  const sx = Math.max(0, Math.min(...srcPoly.map(p=>p.x)));
  const sy = Math.max(0, Math.min(...srcPoly.map(p=>p.y)));
  const ex = Math.min(sW, Math.max(...srcPoly.map(p=>p.x)));
  const ey = Math.min(sH, Math.max(...srcPoly.map(p=>p.y)));
  const sw = Math.max(1, ex - sx), sh = Math.max(1, ey - sy);

  // –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≥–ª–∞–∑–∞–º
  const align = computeAlignment(sLM, dLM, W, H);

  // —Ä–∏—Å—É–µ–º –ª–∏—Ü–æ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
  const temp = document.createElement('canvas'); temp.width=sw; temp.height=sh;
  const tctx = temp.getContext('2d'); tctx.drawImage(src, sx,sy,sw,sh, 0,0,sw,sh);

  // –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É –∫–∞–∫ –∞–ª—å—Ñ—É –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ
  ctx.save();
  ctx.globalCompositeOperation = 'destination-over'; // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏–º —Ñ–æ–Ω
  ctx.restore();

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π
  const layer = document.createElement('canvas'); layer.width=W; layer.height=H;
  const lctx = layer.getContext('2d');
  drawImageWithTransform(lctx, temp, 0,0,sw,sh, align.target.x, align.target.y, align.scale, align.rot);

  // –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–º-–æ–≤–∞–ª–æ–º (–º—è–≥–∫–∞—è –º–∞—Å–∫–∞)
  const masked = document.createElement('canvas'); masked.width=W; masked.height=H;
  const mctx = masked.getContext('2d');
  mctx.drawImage(layer,0,0);
  mctx.globalCompositeOperation = 'destination-in';
  mctx.drawImage(mask,0,0);

  // –ù–∞–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ñ–æ–Ω
  ctx.drawImage(masked,0,0);

  return canvas.toDataURL('image/png');
}

/* ===== Generate ===== */
btn.addEventListener('click', async ()=>{
  hideErr(); showLoading(true); btn.disabled = true;
  resultBox.style.display='none'; resultImg.removeAttribute('src'); download.style.display='none';

  try{
    if (!file || !role) throw new Error("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å.");

    const b64 = await fileToB64(file);
    const fd  = new FormData();
    fd.append("role", role);
    fd.append("image_b64", b64); // –Ω–µ –æ–±—è–∑., –Ω–æ –ø—É—Å—Ç—å –±—É–¥–µ—Ç

    const ctl = new AbortController();
    const timeout = setTimeout(()=>ctl.abort(), 90000);
    const url = (API_BASE || "").trim() + "/api/generate";

    const resp = await fetch(url, { method:"POST", body:fd, signal:ctl.signal });
    clearTimeout(timeout);

    const raw  = await resp.text();
    let data = null; try { data = JSON.parse(raw); } catch {}

    if (!resp.ok) {
      const msg = data?.error || `HTTP ${resp.status}`;
      const details = data?.details || data?.hint || data?.attempts || data?.diag;
      showErr(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${msg}${details ? `\n\ndetails:\n${(typeof details==='string'?details:JSON.stringify(details,null,2))}`:""}`);
      return;
    }
    if (!data?.imageBase64) { showErr("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏."); return; }

    const userDataUrl = `data:image/*;base64,${b64}`;
    const genDataUrl  = `data:image/*;base64,${data.imageBase64}`;

    let composed;
    try{
      composed = await faceLockComposite(userDataUrl, genDataUrl);
    }catch(e){
      console.warn("faceLockComposite failed, fallback to generated:", e);
      composed = genDataUrl; // –º—è–≥–∫–∏–π —Ñ–æ–ª–±—ç–∫
    }

    const finalUrl = await addLogoToBase64(composed);

    resultImg.src = finalUrl;
    resultBox.style.display='block';
    download.href = finalUrl;
    download.style.display='inline-block';
  }catch(e){
    console.error(e);
    showErr(e);
  }finally{
    showLoading(false);
    btn.disabled = false;
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Почувствуй себя журналистом</title>
  <meta name="description" content="Журналист / Блогер / Фотограф — смена фона и образа с сохранением лица и рук" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,"Avenir Next",Segoe UI,Roboto,Helvetica,Arial;}
    body { display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    header { text-align:center; margin-top:24px; margin-bottom:16px; }
    h1 { font-size:clamp(28px,4vw,42px); margin:0; font-weight:800; }
    .container { width:100%; max-width:960px; padding:20px; }
    .uploader { border:2px dashed var(--border); border-radius:24px; padding:40px 20px; background:#f9fafb; text-align:center; cursor:pointer; transition:.2s; }
    .uploader:hover { border-color:var(--accent); background:#f0f9ff; }
    .uploader img.logo { width:72px; height:72px; margin-bottom:12px; }
    .headline { font-weight:700; font-size:18px; }
    .sub { color:var(--muted); font-size:14px; margin-top:6px; }
    .picked { margin-top:10px; font-size:14px; }
    .roles { margin-top:24px; }
    .roles-title { text-align:center; font-weight:700; font-size:18px; }
    .roles-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:720px){ .roles-grid{grid-template-columns:repeat(3,1fr);} }
    .role { border:1px solid var(--border); border-radius:14px; padding:12px; font-weight:700; cursor:pointer; background:#fff; transition:.15s; }
    .role:hover { box-shadow:0 4px 10px rgba(0,0,0,0.05); }
    .role.active { border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.2); }
    .status { margin-top:20px; text-align:center; font-size:15px; white-space:pre-wrap; }
    .err { color:#dc2626; font-size:14px; text-align:center; margin-top:10px; display:none; white-space:pre-wrap; }
    .result { margin-top:24px; text-align:center; }
    .result img { width:100%; max-width:800px; border-radius:18px; border:1px solid var(--border); }
    .btn { background:#10b981; color:#fff; padding:10px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:700; }
    .btn:hover { background:#059669; }
    footer { margin-top:40px; text-align:center; color:#6b7280; font-size:14px; }
    pre#logs { text-align:left; background:#0b1020; color:#cbd5e1; padding:12px; border-radius:12px; overflow:auto; max-height:260px; font-size:12px; display:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Почувствуй себя журналистом</h1></header>

    <div class="uploader" id="dropzone">
      <img src="logo.png" alt="Логотип" class="logo" onerror="this.style.display='none'">
      <div class="headline">Загрузите фото</div>
      <div class="sub">JPG, PNG, WEBP до 12 МБ</div>
      <input id="fileInput" type="file" accept="image/jpeg,image/png,image/webp" style="display:none" />
      <div id="picked" class="picked"></div>
    </div>

    <div class="roles">
      <div class="roles-title">Выберите роль</div>
      <div class="roles-grid">
        <button class="role active" data-role="журналист">Журналист</button>
        <button class="role" data-role="блогер">Блогер</button>
        <button class="role" data-role="фотограф">Фотограф</button>
      </div>
    </div>

    <div id="status" class="status">Готово к работе</div>
    <div id="error" class="err"></div>

    <div id="resultBox" class="result" style="display:none;">
      <img id="resultImg" alt="Результат">
      <div style="margin-top:12px;">
        <a id="download" class="btn" download="result.png" style="display:none;">Скачать PNG</a>
      </div>
    </div>

    <pre id="logs"></pre>
  </div>

  <footer>© 2025 факультет журналистики МГУ</footer>

<script>
const API_BASE = "https://media-gen-worker.vneboriba.workers.dev";
const MAX_MB = 12;
const MAX_SIZE = 1024;

let file = null;
let role = "журналист";
let bp = null;

const S_BG_STRENGTH = 0.68; // сила инпейнта фона
const S_WARDROBE    = 0.38; // мягкая смена одежды

const input = document.getElementById("fileInput");
const drop = document.getElementById("dropzone");
const picked = document.getElementById("picked");
const statusEl = document.getElementById("status");
const err = document.getElementById("error");
const resultBox = document.getElementById("resultBox");
const resultImg = document.getElementById("resultImg");
const download = document.getElementById("download");
const logsEl = document.getElementById("logs");

function showErr(m){ err.style.display="block"; err.innerText=m; statusEl.innerText="Ошибка"; }
function hideErr(){ err.style.display="none"; err.innerText=""; }
function log(obj){ try{ logsEl.style.display="block"; logsEl.textContent = typeof obj==="string"?obj:JSON.stringify(obj,null,2);}catch{} }

function fetchTO(url, init={}, ms=120000){
  const ctrl = new AbortController(); const id=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url, {...init, signal:ctrl.signal}).finally(()=>clearTimeout(id));
}

drop.addEventListener("click",()=>input.click());
drop.addEventListener("dragover",e=>e.preventDefault());
drop.addEventListener("drop",e=>{e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
input.addEventListener("change",e=>handleFile(e.target.files?.[0]));

document.querySelectorAll(".role").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".role").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    role=b.dataset.role;
    if (file) generate();
  });
});

function loadImg(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function loadBP(){ if (bp) return bp; statusEl.innerText="Загрузка сегментации…"; bp = await bodyPix.load({architecture:"MobileNetV1", outputStride:16, multiplier:0.75, quantBytes:2}); return bp; }

function handleFile(f){
  if (!f) return;
  if (!f.type.startsWith("image/")) return showErr("Нужен файл изображения.");
  if (f.size>MAX_MB*1024*1024) return showErr("Слишком большой файл (до 12 МБ).");
  hideErr(); file=f; picked.innerText=`Вы выбрали: ${f.name}`; generate();
}

async function resizeFile(f){
  const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
  const im = await loadImg(dataUrl);
  let w=im.width,h=im.height, k=Math.max(w,h)>MAX_SIZE?MAX_SIZE/Math.max(w,h):1;
  w=Math.round(w*k); h=Math.round(h*k);
  const c=document.createElement("canvas"); c.width=w; c.height=h; c.getContext("2d").drawImage(im,0,0,w,h);
  const du=c.toDataURL("image/jpeg",0.92);
  return { dataUrl: du, b64: du.split(",")[1], w, h };
}

/* строим две вещи:
   1) mask_bg_b64 — белое=ФОН (менять), чёрное=ЧЕЛОВЕК (сохранить);
   2) overlay_headhands_b64 — PNG с альфой (голова+шея+руки), для финального оверлея. */
async function buildMasks(dataUrl){
  const model = await loadBP();
  const img = await loadImg(dataUrl);
  const w=img.width,h=img.height;

  // сегментация частей
  const parts = await model.segmentPersonParts(img, { internalResolution:'medium', segmentationThreshold:0.7 });

  // id частей (BodyPix): 0—face,1—hair, 2–7 arms/legs etc (зависят от модели).
  // Возьмём face, hair, left/right arm & hand (обычно 2–5).
  const HEAD = new Set([0,1]);
  const ARMS = new Set([2,3,4,5]); // л/п рука/предплечье

  const isHeadOrArms = i => HEAD.has(parts.data[i]) || ARMS.has(parts.data[i]);

  // --- MASK_BG: белый=менять, чёрный=оставить (человек)
  const c1=document.createElement("canvas"); c1.width=w; c1.height=h;
  const g1=c1.getContext("2d");
  const i1=g1.createImageData(w,h);
  for (let i=0;i<w*h;i++){
    const v = isHeadOrArms(i) || parts.data[i]!==-1 ? 0 : 255; // всё, что модель считает человеком, оставляем
    i1.data[i*4+0]=v; i1.data[i*4+1]=v; i1.data[i*4+2]=v; i1.data[i*4+3]=255;
  }
  g1.putImageData(i1,0,0);

  // расширим белое (фон) на 10px и снизу «подиум» — чтобы добавить реквизит
  const c2=document.createElement("canvas"); c2.width=w; c2.height=h;
  const g2=c2.getContext("2d"); g2.filter="blur(5px)"; g2.drawImage(c1,0,0);
  const g2b=c2.getContext("2d"); // already blurred
  // добавим полосу снизу
  g2b.fillStyle="#fff"; g2b.fillRect(0, h-Math.max(10,Math.round(h*0.1)), w, h);

  const mask_bg_b64 = c2.toDataURL("image/png").split(",")[1];

  // --- OVERLAY: голова+шея+руки (мягкая альфа)
  const base = await loadImg(dataUrl);
  const m=document.createElement("canvas"); m.width=w; m.height=h;
  const gm=m.getContext("2d");
  const id=gm.createImageData(w,h);
  for (let i=0;i<w*h;i++){
    const v = isHeadOrArms(i) ? 255 : 0;
    id.data[i*4+0]=0; id.data[i*4+1]=0; id.data[i*4+2]=0; id.data[i*4+3]=v;
  }
  gm.putImageData(id,0,0);
  const blur=document.createElement("canvas"); blur.width=w; blur.height=h;
  const gb=blur.getContext("2d"); gb.filter="blur(7px)"; gb.drawImage(m,0,0);
  const overlay=document.createElement("canvas"); overlay.width=w; overlay.height=h;
  const go=overlay.getContext("2d");
  go.drawImage(base,0,0,w,h);
  go.globalCompositeOperation="destination-in"; go.drawImage(blur,0,0); go.globalCompositeOperation="source-over";
  const overlay_headhands_b64 = overlay.toDataURL("image/png").split(",")[1];

  return { mask_bg_b64, overlay_headhands_b64 };
}

/* лого-оверлей */
async function composeLogoOver(imgDataUrl){
  const base = await loadImg(imgDataUrl);
  const logo = await loadImg("logo.png").catch(()=>null);
  if (!logo) return imgDataUrl;
  const w=base.width,h=base.height;
  const c=document.createElement("canvas"); c.width=w; c.height=h; const g=c.getContext("2d");
  g.drawImage(base,0,0,w,h);
  const logoW=Math.max(120,Math.round(w*0.16)); const scale=logoW/logo.width; const logoH=Math.round(logo.height*scale);
  const pad=Math.max(16,Math.round(Math.min(w,h)*0.02)); const x=w-logoW-pad; const y=h-logoH-pad;
  g.fillStyle="rgba(255,255,255,0.85)"; const br=Math.round(logoH*0.18);
  g.beginPath(); g.moveTo(x+br,y); g.arcTo(x+logoW,y,x+logoW,y+logoH,br); g.arcTo(x+logoW,y+logoH,x,y+logoH,br); g.arcTo(x,y+logoH,x,y,br); g.arcTo(x,y,x+logoW,y,br); g.closePath(); g.fill();
  g.drawImage(logo,x,y,logoW,logoH);
  return c.toDataURL("image/png");
}

function bgPrompt(role){
  if (role==="журналист") return "TV news studio with broadcast cameras, boom mics, glass anchor desk, video walls showing newsroom graphics; cinematic editorial lighting; photorealistic; no text";
  if (role==="блогер")    return "creator studio with ring light, green screen, camera on tripod, softbox lights, colorful LED accents; photorealistic; no text";
  if (role==="фотограф")  return "professional photo studio with backdrop rolls, C-stands, softboxes and camera gear; moody studio lighting; photorealistic; no text";
  return "neutral professional studio background; photorealistic; no text";
}
function outfitPrompt(role){
  if (role==="журналист") return "subtle outfit shift to smart-casual journalist: blazer or tailored jacket over top, neutral tones; keep same person and identity";
  if (role==="блогер")    return "subtle outfit shift to trendy blogger: stylish casual, light hoodie or tee, denim or relaxed trousers; keep same person and identity";
  if (role==="фотограф")  return "subtle outfit shift to photographer: dark utility vest or jacket, practical look; keep same person and identity";
  return "subtle outfit update; keep identity";
}

async function generate(){
  if (!file) return;
  statusEl.innerText="Подготовка…"; resultBox.style.display="none"; download.style.display="none"; hideErr(); logsEl.style.display="none";
  try{
    const resized = await resizeFile(file);
    statusEl.innerText="Сегментация (фон/голова+руки)…";
    const { mask_bg_b64, overlay_headhands_b64 } = await buildMasks(resized.dataUrl);

    // Шаг 1: INPAINT — меняем ТОЛЬКО фон
    statusEl.innerText="Шаг 1/2: меняем фон…";
    let fd = new FormData();
    fd.append("mode","bg-inpaint");
    fd.append("role", role);
    fd.append("image_b64", resized.b64);
    fd.append("mask_b64", mask_bg_b64);
    fd.append("prompt", bgPrompt(role));
    fd.append("strength", String(S_BG_STRENGTH));
    let r = await fetchTO(`${API_BASE}/api/safe-edit`, { method:"POST", body:fd }, 120000);
    let j = JSON.parse(await r.text());
    log({step:"inpaint", j});
    if (!r.ok || !j.imageBase64) return showErr(j?.error||"Ошибка inpaint");

    let currentUrl = "data:image/png;base64,"+j.imageBase64;

    // Шаг 2: WARDROBE — мягко меняем одежду (img2img)
    statusEl.innerText="Шаг 2/2: обновляем одежду…";
    const baseImgB64 = currentUrl.split(",")[1];
    fd = new FormData();
    fd.append("mode","wardrobe");
    fd.append("role", role);
    fd.append("image_b64", baseImgB64);
    fd.append("prompt", outfitPrompt(role));
    fd.append("strength", String(S_WARDROBE));
    r = await fetchTO(`${API_BASE}/api/safe-edit`, { method:"POST", body:fd }, 120000);
    j = JSON.parse(await r.text());
    log({step:"wardrobe", j});
    if (!r.ok || !j.imageBase64) return showErr(j?.error||"Ошибка wardrobe");

    // Финальная композиция: кладём сверху head+hands overlay из исходника
    statusEl.innerText="Финальная сборка…";
    const finalCanvas = document.createElement("canvas");
    const gen = await loadImg("data:image/png;base64,"+j.imageBase64);
    finalCanvas.width=gen.width; finalCanvas.height=gen.height;
    const g = finalCanvas.getContext("2d");
    g.drawImage(gen,0,0,gen.width,gen.height);
    const head = await loadImg("data:image/png;base64,"+overlay_headhands_b64);
    g.drawImage(head,0,0,gen.width,gen.height);
    let finalUrl = finalCanvas.toDataURL("image/png");

    // Лого
    finalUrl = await composeLogoOver(finalUrl);

    resultImg.src = finalUrl;
    resultBox.style.display="block";
    download.href = finalUrl;
    download.style.display="inline-block";
    statusEl.innerText="Готово ✓ · фон + одежда";
  }catch(e){
    showErr(e.message||"Неизвестная ошибка");
  }
}
</script>
</body>
</html>
